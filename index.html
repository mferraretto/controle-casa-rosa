<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Controle de Pedidos Casa Rosa</title>

  <!-- Fonte Inter moderna -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <!-- √çcones Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <!-- Select2 para filtros -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

  <!-- Bibliotecas JS auxiliares -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Objeto global antes de tudo -->
  <script>window.AppCasaRosa = window.AppCasaRosa || {};</script>

  <!-- Firebase App + Firestore + Auth (modular) -->
  <script type="module">
    // Importa√ß√£o dos m√≥dulos Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      onSnapshot,
      query,
      orderBy,
      updateDoc,
      deleteDoc,
      doc,
      getDoc,
      getDocs
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    // Configura√ß√£o do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDanvDxs2RDaMNc7zARyyyUt0rLqes95H0",
      authDomain: "painelpedidos-v2.firebaseapp.com",
      projectId: "painelpedidos-v2",
      storageBucket: "painelpedidos-v2.appspot.com",
      messagingSenderId: "135497440608",
      appId: "1:135497440608:web:093e8fc4264257d5065205"
    };

    // Inicializa Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Disponibiliza m√©todos Firebase no objeto global
    window.AppCasaRosa.db = db;
    window.AppCasaRosa.auth = auth;
    window.AppCasaRosa.collection = collection;
    window.AppCasaRosa.addDoc = addDoc;
    window.AppCasaRosa.onSnapshot = onSnapshot;
    window.AppCasaRosa.query = query;
    window.AppCasaRosa.orderBy = orderBy;
    window.AppCasaRosa.updateDoc = updateDoc;
    window.AppCasaRosa.deleteDoc = deleteDoc;
    window.AppCasaRosa.doc = doc;
    window.AppCasaRosa.getDoc = getDoc;
    window.AppCasaRosa.getDocs = getDocs;
    window.AppCasaRosa.signInWithEmailAndPassword = signInWithEmailAndPassword;
    window.AppCasaRosa.signOut = signOut;
    window.AppCasaRosa.onAuthStateChanged = onAuthStateChanged;

    // Observador de SKUs equivalentes
    window.AppCasaRosa.skusEquivalentes = {};
    onSnapshot(collection(db, "skus_equivalentes"), snap => {
      const equivalentes = {};
      snap.docs.forEach(doc => {
        const data = doc.data();
        if (data.base) {
          equivalentes[data.base] = data.equivalentes || [];
        }
      });
      window.AppCasaRosa.skusEquivalentes = equivalentes;
      console.log("üü¢ SKUs equivalentes atualizados:", equivalentes);
    });

    // Fun√ß√£o de login
    window.AppCasaRosa.fazerLogin = function () {
      const email = document.getElementById("emailLogin")?.value.trim();
      const senha = document.getElementById("senhaLogin")?.value;
      const erroElem = document.getElementById("erroLogin");

      if (!email || !senha) {
        if (erroElem) erroElem.textContent = "Preencha e-mail e senha.";
        return;
      }

      signInWithEmailAndPassword(auth, email, senha)
        .then(userCredential => {
          console.log("Login realizado:", userCredential.user.email);
          if (erroElem) erroElem.textContent = "";
        })
        .catch(error => {
          console.error("Erro de login:", error);
          if (erroElem) erroElem.textContent = "Email ou senha inv√°lidos.";
          const senhaInput = document.getElementById("senhaLogin");
          if (senhaInput) senhaInput.value = "";
        });
    };

    // Verifica autentica√ß√£o ao carregar
    document.addEventListener("DOMContentLoaded", () => {
      onAuthStateChanged(auth, (user) => {
        const loginTela = document.getElementById("login");
        const sistemaTela = document.getElementById("sistema");
        if (user) {
          loginTela.style.display = "none";
          sistemaTela.style.display = "block";
          AppCasaRosa.carregarSkusEquivalentes && AppCasaRosa.carregarSkusEquivalentes();
          AppCasaRosa.carregarLojasRegistradas && AppCasaRosa.carregarLojasRegistradas();
        } else {
          loginTela.style.display = "flex";
          sistemaTela.style.display = "none";
        }
      });
    });
window.AppCasaRosa.deslogarUsuario = function () {
  signOut(auth).then(() => location.reload());
};
  // Remover pendentes que j√° est√£o como enviados
async function removerPendentesJaEnviados() {
  try {
    const pendentesSnap = await AppCasaRosa.getDocs(AppCasaRosa.collection(AppCasaRosa.db, "pedidos_pendentes"));
    const enviadosSnap  = await AppCasaRosa.getDocs(AppCasaRosa.collection(AppCasaRosa.db, "pedidos_enviados"));

    const enviadosIds = new Set();
    enviadosSnap.forEach(doc => {
      const id = AppCasaRosa.normalizarId(doc.data().pedidoId || doc.data().Pedido || "");
      enviadosIds.add(id);
    });

    const promises = [];
    pendentesSnap.forEach(doc => {
      const id = AppCasaRosa.normalizarId(doc.data().pedidoId || doc.data().Pedido || "");
      if (enviadosIds.has(id)) {
        promises.push(deleteDoc(doc.ref));
      }
    });

    await Promise.all(promises);
    alert("‚úÖ Pedidos duplicados removidos da aba 'Novos a Enviar'.");
    location.reload();
  } catch (e) {
    alert("Erro ao remover pendentes: " + (e.message || e));
  }
}

window.AppCasaRosa = window.AppCasaRosa || {};
window.AppCasaRosa.removerPendentesJaEnviados = removerPendentesJaEnviados;
window.AppCasaRosa.db = db;
window.AppCasaRosa.collection = collection;
window.AppCasaRosa.addDoc = addDoc;
window.AppCasaRosa.onSnapshot = onSnapshot;
window.AppCasaRosa.doc = doc;
window.AppCasaRosa.updateDoc = updateDoc;
window.AppCasaRosa.deleteDoc = deleteDoc;
window.AppCasaRosa.getDoc = getDoc;
window.AppCasaRosa.getDocs = getDocs;

window.AppCasaRosa.importadosList = [];
window.AppCasaRosa.enviadosList = [];
window.AppCasaRosa.canceladosList = [];
window.AppCasaRosa.pdfsList = [];
window.AppCasaRosa.historicoList = [];
window.AppCasaRosa.produtosMap = {};

// Listener "Pedidos Enviados"
onSnapshot(collection(db, "pedidos_enviados"), (snapshot) => {
  window.AppCasaRosa.enviadosList = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
  // Use window. se a fun√ß√£o tamb√©m for global
  if (window.AppCasaRosa.atualizarTabelasEViewsEnviados) {
    window.AppCasaRosa.atualizarTabelasEViewsEnviados();
  }
});
// Fun√ß√£o de escape HTML
window.AppCasaRosa.escapeHTML = function(str) {
  return (str || "").replace(/[&<>"']/g, function (c) {
    return ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    })[c];
  });
};
  // Atualizar pedido espec√≠fico
  window.AppCasaRosa.atualizarPedido = async function(id, dados) {
  try {
    const ref = doc(db, "pedidos_pendentes", id);
    await updateDoc(ref, dados);
  } catch (e) {
    alert("Erro ao atualizar pedido: " + (e.message || e));
  }
};

// Sincronizar pendentes automaticamente com enviados


// Renderizar tabela de enviados

  
</script>

<script>
  window.AppCasaRosa = window.AppCasaRosa || {};
 window.AppCasaRosa.normalizarId = function(id) {
  return (id || '').toString().trim().toLowerCase().replace(/^0+/, '');
};
  // Fun√ß√£o gen√©rica de renderiza√ß√£o de tabela
window.AppCasaRosa.renderTabela = function(id, lista) {
  // Exemplo: redireciona para a fun√ß√£o de tabela pendentes, se for esse o caso
  if (id === "tabelaPendentes" && typeof AppCasaRosa.renderizarTabelaPendentes === "function") {
    AppCasaRosa.renderizarTabelaPendentes(lista);
  }
  // Adicione outros casos conforme necess√°rio
};
 window.AppCasaRosa.carregarPendentesFirebase = async function() {
  try {
    const snapshot = await AppCasaRosa.getDocs(AppCasaRosa.collection(AppCasaRosa.db, "pedidos_pendentes"));
    const pendentes = [];
    snapshot.forEach(doc => {
      pendentes.push({ id: doc.id, ...doc.data() });
    });

    // Atualize esta parte abaixo
    const enviados = AppCasaRosa.enviadosList || [];
    const idsEnviados = new Set(
      enviados.map(e =>
        (e.Pedido || e.pedidoId || "").toString().trim()
      )
    );
    const pendentesFiltrados = pendentes.filter(p =>
      !idsEnviados.has((p.Pedido || p.pedidoId || "").toString().trim())
    );
// Mant√©m a lista em mem√≥ria para outras funcionalidades
    AppCasaRosa.importadosList = pendentesFiltrados;
    if (typeof AppCasaRosa.renderTabela === "function") {
      AppCasaRosa.renderTabela("tabelaPendentes", pendentesFiltrados);
    } else if (typeof renderTabela === "function") {
      renderTabela("tabelaPendentes", pendentesFiltrados);
    }

    const contador = document.getElementById("contadorPedidosPendentes");
    if (contador) {
      contador.textContent = pendentesFiltrados.length;
    }
    // Atualiza os cards de resumo se a fun√ß√£o existir
    if (typeof AppCasaRosa.atualizarDashboardPendentes === "function") {
      AppCasaRosa.atualizarDashboardPendentes();
    }
  } catch (e) {
    alert("Erro ao carregar pedidos pendentes: " + (e.message || e));
  }
};

  // üîÑ Carrega lista de lojas cadastradas no Firestore
window.AppCasaRosa.carregarLojasRegistradas = async function() {
  try {
    const snap = await AppCasaRosa.getDocs(AppCasaRosa.collection(AppCasaRosa.db, "lojas"));
    AppCasaRosa.lojasRegistradas = snap.docs.map(doc => doc.id);
  } catch (e) {
    alert("Erro ao carregar lojas registradas: " + (e.message || e));
  }
};
window.AppCasaRosa.identificarLoja = function(texto) {
  const linhas = texto.split('\n');
  const indexRemetente = linhas.findIndex(l => l.trim().toUpperCase() === "REMETENTE");

  if (indexRemetente >= 0) {
    for (let i = indexRemetente + 1; i < linhas.length; i++) {
      const linha = linhas[i].trim();

      // Ignora linhas irrelevantes
      if (
        linha === "" ||
        linha.toUpperCase().startsWith("CEP") ||
        /^\d{5}-?\d{3}$/.test(linha) ||         // CEP
        /^\d{1,6}$/.test(linha) ||              // N√∫mero
        /^[\d,.:\/\-]+$/.test(linha) ||         // Endere√ßos num√©ricos
        linha.toLowerCase().includes("avenida") ||
        linha.toLowerCase().includes("rua") ||
        linha.toLowerCase().includes("bairro") ||
        linha.toLowerCase().includes("bloco")
      ) continue;

      // Prov√°vel nome da loja
      if (
        linha.length > 3 &&
        !linha.match(/^\d/) && // n√£o come√ßa com n√∫mero
        !linha.includes("@")   // ignora emails
      ) {
        return linha;
      }
    }
  }

  // üîç Tentativa baseada em Firestore
  if (AppCasaRosa.lojasRegistradas && Array.isArray(AppCasaRosa.lojasRegistradas)) {
    for (const loja of AppCasaRosa.lojasRegistradas) {
      if (texto.toLowerCase().includes(loja.toLowerCase())) {
        return loja;
      }
    }
  }

  // Fallback manual
  const match = texto.match(/(Casa Rosa Decora√ß√µes|Collore Na Web|DAC Store)/i);
  return match ? match[1] : "Loja Desconhecida";
};



</script>


<script>
  window.AppCasaRosa = window.AppCasaRosa || {};
  // Renderiza√ß√£o da tabela de ‚ÄúNovos a Enviar‚Äù
 window.AppCasaRosa.renderizarTabelaPendentes = function(lista) {
  const container = document.getElementById("tabelaPendentes");
  if (!container) return;

  let html = `
    <div style="overflow-x:auto;"><table>
      <thead>
        <tr>
          <th>Pedido</th>
          <th>Loja</th>
          <th>Produto</th>
          <th>Pagamento</th>
          <th>Rastreio</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody>
  `;

  lista.forEach(p => {
    const pedido   = p.Pedido || p.pedidoId || "";
    const loja     = p.Loja || "";
    const produto  = p.SKU || "";
    const pagamento = p.dataPagamento
      ? new Date(p.dataPagamento).toLocaleString()
      : "";
    const rastreio = p.Rastreio || "";

    html += `
<tr>
  <td>${AppCasaRosa.escapeHTML ? AppCasaRosa.escapeHTML(pedido) : escapeHTML(pedido)}</td>
  <td>${AppCasaRosa.escapeHTML ? AppCasaRosa.escapeHTML(loja) : escapeHTML(loja)}</td>
  <td>${AppCasaRosa.escapeHTML ? AppCasaRosa.escapeHTML(produto) : escapeHTML(produto)}</td>
  <td>${AppCasaRosa.escapeHTML ? AppCasaRosa.escapeHTML(pagamento) : escapeHTML(pagamento)}</td>
  <td>${AppCasaRosa.escapeHTML ? AppCasaRosa.escapeHTML(rastreio) : escapeHTML(rastreio)}</td>
  <td><button class="danger" onclick="AppCasaRosa.cancelarPedido ? AppCasaRosa.cancelarPedido('${AppCasaRosa.escapeHTML ? AppCasaRosa.escapeHTML(p.id) : escapeHTML(p.id)}') : cancelarPedido('${AppCasaRosa.escapeHTML ? AppCasaRosa.escapeHTML(p.id) : escapeHTML(p.id)}')">‚ùå Cancelar</button></td>
</tr>
`;
  });

  html += "</tbody></table></div>";
  container.innerHTML = html;

  // Remova ou adapte a chamada para atualizarTabelas conforme sua necessidade:
  // if (typeof AppCasaRosa.atualizarTabelas === "function") AppCasaRosa.atualizarTabelas();
};
// Exibe pendentes em formato de cards
window.AppCasaRosa.renderizarCardsPendentes = function(lista) {
  const container = document.getElementById("cardsPendentes");
  if (!container) return;
  container.innerHTML = "";
  lista.forEach(p => {
    const pedido   = p.Pedido || p.pedidoId || "";
    const loja     = p.Loja || "";
    const produto  = p.SKU || "";
    const pagamento = p.dataPagamento ? new Date(p.dataPagamento).toLocaleDateString() : "";
    const rastreio = p.Rastreio || "";
    const div = document.createElement("div");
    div.className = "card-pendente";
    div.innerHTML = `
      <strong>Pedido:</strong> ${AppCasaRosa.escapeHTML ? AppCasaRosa.escapeHTML(pedido) : pedido}<br/>
      <strong>Loja:</strong> ${AppCasaRosa.escapeHTML ? AppCasaRosa.escapeHTML(loja) : loja}<br/>
      <strong>Produto:</strong> ${AppCasaRosa.escapeHTML ? AppCasaRosa.escapeHTML(produto) : produto}<br/>
      <strong>Pagamento:</strong> ${AppCasaRosa.escapeHTML ? AppCasaRosa.escapeHTML(pagamento) : pagamento}<br/>
      <strong>Rastreio:</strong> ${AppCasaRosa.escapeHTML ? AppCasaRosa.escapeHTML(rastreio) : rastreio}<br/>
      <button class="danger" onclick="AppCasaRosa.cancelarPedido('${p.id}')">‚ùå Cancelar</button>
    `;
    container.appendChild(div);
  });
};

// Alterna entre tabela e cards
window.AppCasaRosa.alternarVisualizacaoPedidos = function() {
  const tabela = document.getElementById("tabelaPendentes");
  const cards  = document.getElementById("cardsPendentes");
  const btn    = document.getElementById("btnVisualizacaoPedidos");
  if (!tabela || !cards || !btn) return;

  if (tabela.style.display === "none") {
    tabela.style.display = "";
    cards.style.display = "none";
    btn.textContent = "üì¶ Visualizar como Cards";
  } else {
    const enviadosSet = new Set((AppCasaRosa.enviadosList || []).map(e => (e.pedidoId || e.Pedido || "").toString().trim()));
    const lista = (AppCasaRosa.importadosList || []).filter(p => !enviadosSet.has((p.pedidoId || p.Pedido || "").toString().trim()));
    AppCasaRosa.renderizarCardsPendentes(lista);
    tabela.style.display = "none";
    cards.style.display = "grid";
    btn.textContent = "üìã Visualizar como Tabela";
  }
};


window.AppCasaRosa.renderizarTabelaMetas = function() {
  const lojas = [...new Set((AppCasaRosa.enviadosList || []).map(p => p.Loja).filter(Boolean))];
  const tbody = document.querySelector("#tabela-metas tbody");
  tbody.innerHTML = "";

  lojas.forEach(loja => {
    const meta = (window.metasPorLoja && window.metasPorLoja[loja]) || "";
    const linha = document.createElement("tr");
    linha.innerHTML = `
      <td style="padding:0.5rem;">${AppCasaRosa.escapeHTML ? AppCasaRosa.escapeHTML(loja) : escapeHTML(loja)}</td>
      <td style="padding:0.5rem;">
        <input type="number" min="0" value="${AppCasaRosa.escapeHTML ? AppCasaRosa.escapeHTML(meta) : escapeHTML(meta)}" data-loja="${AppCasaRosa.escapeHTML ? AppCasaRosa.escapeHTML(loja) : escapeHTML(loja)}" style="width:100px;" />
      </td>
      <td style="padding:0.5rem;">
        <button onclick="AppCasaRosa.removerMeta('${AppCasaRosa.escapeHTML ? AppCasaRosa.escapeHTML(loja) : escapeHTML(loja)}')">‚ùå Remover</button>
      </td>
    `;
    tbody.appendChild(linha);
  });
};
function salvarMetas() {
  const inputs = document.querySelectorAll("#tabela-metas input[data-loja]");
  inputs.forEach(input => {
    const loja = input.dataset.loja;
    const valor = parseInt(input.value);
    if (!isNaN(valor)) {
      metasPorLoja[loja] = valor;
    }
  });
  localStorage.setItem("metasPorLoja", JSON.stringify(metasPorLoja));
  alert("üéØ Metas salvas com sucesso!");
}

window.AppCasaRosa.removerMeta = function(loja) {
  delete metasPorLoja[loja];
  localStorage.setItem("metasPorLoja", JSON.stringify(metasPorLoja));
  if (typeof AppCasaRosa.renderizarTabelaMetas === "function") {
    AppCasaRosa.renderizarTabelaMetas();
  } else if (typeof renderizarTabelaMetas === "function") {
    renderizarTabelaMetas();
  }
};


</script>


<script>
  window.AppCasaRosa = window.AppCasaRosa || {};
 window.AppCasaRosa.renderizarTabelaEnviados = function(lista) {
  const container = document.getElementById("tabela-enviados");
  if (!container) return;

  let html = `
    <div style="overflow-x:auto;"><table>
      <thead>
        <tr>
          <th>Pedido</th>
          <th>Loja</th>
          <th>Produto</th>
          <th>Rastreio</th>
          <th>Pagamento</th>
          <th>Data Envio</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody>
  `;

  lista.forEach(p => {
    const pedido   = p.pedidoId || "-";
    const loja     = p.Loja || "-";
    const produto  = p.SKU || "-";
    const rastreio = p.Rastreio || "-";
    const pag      = p.dataPagamento ? new Date(p.dataPagamento).toLocaleDateString() : "-";
    const envio    = p.dataEnvio ? new Date(p.dataEnvio).toLocaleDateString() : "-";

    html += `
  <tr>
    <td>${AppCasaRosa.escapeHTML ? AppCasaRosa.escapeHTML(pedido) : escapeHTML(pedido)}</td>
    <td>${AppCasaRosa.escapeHTML ? AppCasaRosa.escapeHTML(loja) : escapeHTML(loja)}</td>
    <td>${AppCasaRosa.escapeHTML ? AppCasaRosa.escapeHTML(produto) : escapeHTML(produto)}</td>
    <td>${AppCasaRosa.escapeHTML ? AppCasaRosa.escapeHTML(rastreio) : escapeHTML(rastreio)}</td>
    <td>${AppCasaRosa.escapeHTML ? AppCasaRosa.escapeHTML(pag) : escapeHTML(pag)}</td>
    <td>${AppCasaRosa.escapeHTML ? AppCasaRosa.escapeHTML(envio) : escapeHTML(envio)}</td>
    <td>
      <button class="danger" onclick="AppCasaRosa.cancelarPedido ? AppCasaRosa.cancelarPedido('${AppCasaRosa.escapeHTML ? AppCasaRosa.escapeHTML(p.id) : escapeHTML(p.id)}') : cancelarPedido('${AppCasaRosa.escapeHTML ? AppCasaRosa.escapeHTML(p.id) : escapeHTML(p.id)}')">‚ùå Cancelar</button>
    </td>
  </tr>
`;
  });

  html += `</tbody></table></div>`;
  container.innerHTML = html;
};


  // Renderiza√ß√£o da tabela de ‚ÄúCancelados‚Äù
 window.AppCasaRosa.renderizarTabelaCancelados = function(lista) {
  const tbody = document.querySelector("#tabela-cancelados tbody");
  tbody.innerHTML = "";
  lista.forEach(p => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${AppCasaRosa.escapeHTML ? AppCasaRosa.escapeHTML(p.Loja || "") : escapeHTML(p.Loja || "")}</td>
      <td>${AppCasaRosa.escapeHTML ? AppCasaRosa.escapeHTML(p.motivo || "") : escapeHTML(p.motivo || "")}</td>
    `;
    tbody.appendChild(tr);
  });
};

// Marca um pedido como ‚Äúenviado‚Äù no Firestore
window.AppCasaRosa.marcarEnviado = function(id) {
  if (typeof AppCasaRosa.atualizarPedido === "function") {
    AppCasaRosa.atualizarPedido(id, {
      status: "enviado",
      dataEnvio: new Date().toISOString()
    });
  } else if (typeof atualizarPedido === "function") {
    atualizarPedido(id, {
      status: "enviado",
      dataEnvio: new Date().toISOString()
    });
  }
};

// Cancela um pedido: atualiza status e registra em cole√ß√£o ‚Äúpedidos_cancelados‚Äù
window.AppCasaRosa.cancelarPedido = async function(id) {
  try {
    const motivo = prompt("Digite o motivo do cancelamento:");
    if (!motivo) return;
    // 1) Atualiza o pr√≥prio pedido
    if (typeof AppCasaRosa.atualizarPedido === "function") {
      await AppCasaRosa.atualizarPedido(id, {
        status: "cancelado",
        motivo,
        dataCancelamento: new Date().toISOString()
      });
    } else if (typeof atualizarPedido === "function") {
      await atualizarPedido(id, {
        status: "cancelado",
        motivo,
        dataCancelamento: new Date().toISOString()
      });
    }
    // 2) Registra em cole√ß√£o espec√≠fica de cancelados
    await addDoc(
      collection(db, "pedidos_cancelados"),
      {
        pedidoId: id,
        motivo,
        dataCancelamento: new Date().toISOString()
      }
    );
  } catch (e) {
    alert("Erro ao cancelar pedido: " + (e.message || e));
  }
};
</script>


 <style>
  body {
    font-family: 'Inter', sans-serif;
    background: #f3f4f6;
    color: #212529;
    padding: 1rem;
  }

  h1 {
    text-align: center;
    color: #dc3545;
  }

  .tabs {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin: 1rem auto;
  }

  .tab {
    padding: 0.6rem 1.2rem;
    background-color: #e9ecef;
    color: #212529;
    font-weight: 500;
    border-radius: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    transition: background 0.2s ease, color 0.2s ease;
    border: 2px solid transparent;
  }

  .tab:hover {
    background-color: #dee2e6;
  }

  .tab.active {
    background-color: #dc3545;
    color: white;
    font-weight: 600;
    border-color: #dc3545;
  }

  .tab-content {
    display: none;
    border: 1px solid #dee2e6;
    padding: 1rem;
    background: white;
  }

  .tab-content.active {
    display: block;
  }

  input[type="file"],
  input[type="date"] {
    margin: 0.5rem 0;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
    border-radius: 6px;
    box-shadow: 0 0 8px rgba(0, 0, 0, 0.05);
    overflow: hidden;
  }

  th,
  td {
    border: 1px solid #ccc;
    padding: 0.5rem;
    text-align: left;
  }

  th {
    background: #dc3545;
    color: white;
  }

  tr:nth-child(even) {
    background-color: #f2f2f2;
  }

  button {
    margin: 0.5rem 0.25rem;
    padding: 0.5rem 1rem;
    background: #198754;
    color: white;
    border: none;
    border-radius: 0.25rem;
    cursor: pointer;
  }

  .danger {
    background: #dc3545;
  }

  .dashboard-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
  }

  .dashboard-header h2 {
    font-size: 1.6rem;
    color: #343a40;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .titulo-secao {
    font-size: 1.75rem;
    font-weight: 700;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #212529;
    letter-spacing: -0.5px;
  }

  .filtros-dashboard {
    display: flex;
    flex-wrap: wrap;
    gap: 2rem;
    margin-top: 1rem;
    margin-bottom: 2.5rem;
  }
.card-filtros select {
  width: 100%;
  padding: 0.4rem 0.6rem;
  font-size: 0.9rem;
  border-radius: 6px;
  border: 1px solid #ccc;
}

.card-filtros label {
  display: flex;
  flex-direction: column;
  flex: 1 1 220px;
  margin-bottom: 0.25rem;
}


  .filtros-dashboard label strong i {
    background: #ffffff;
    color: #dc3545;
    padding: 0.45rem;
    border-radius: 50%;
    margin-right: 0.5rem;
    font-size: 0.75rem;
    width: 1.7rem;
    height: 1.7rem;
    display: flex;
    justify-content: center;
    align-items: center;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
  }

  .filtros-dashboard select {
    width: 250px;
    padding: 0.5rem;
    border: 1px solid #ccc;
    border-radius: 6px;
    background: white;
    font-size: 0.95rem;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
  }

  .cards-status {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 2.5rem;
  }

  .card-status {
    flex: 1 1 200px;
    padding: 1.25rem;
    border-radius: 12px;
    font-weight: bold;
    text-align: center;
    box-shadow: 0 4px 8px rgba(0,0,0,0.06);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .card-status:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
  }

  .card-novos {
    background-color: #fffbea;
    color: #856404;
  }

  .card-atraso {
    background-color: #fdecea;
    color: #721c24;
  }

  .card-risco {
    background-color: #fff8e1;
    color: #856404;
  }

  .card-enviados {
    background-color: #e8f5e9;
    color: #155724;
  }

  .card-status strong {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    font-size: 1.1rem;
  }

  .card-status span {
    font-size: 1.6rem;
    font-weight: bold;
    margin-top: 0.3rem;
    display: inline-block;
  }

  .filtros-simples {
    margin-bottom: 1.5rem;
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .filtros-simples label {
    font-weight: 500;
    color: #343a40;
  }
@media (max-width: 768px) {
  .card-filtros {
    flex-direction: column;
  }

  .card-filtros select {
    width: 100%;
  }
}

.card-percentual-atraso {
    background-color: #e2e3f3;
    color: #383d65;
  }

  /* Visualiza√ß√£o em cards para os pedidos */
  .cards-pendentes {
    display: grid;
    gap: 1rem;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  }

  .card-pendente {
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 0.75rem;
    background: #fff;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  }
body.dark-mode {
  background-color: #121212;
  color: #f5f5f5;
}

body.dark-mode .tab-content,
body.dark-mode .card-status,
body.dark-mode .filtros-dashboard,
body.dark-mode #card-vendas-mensais,
body.dark-mode .dashboard-header {
  background-color: #1e1e1e;
  border-color: #333;
  color: #f5f5f5;
}

body.dark-mode button {
  background-color: #333;
  color: #fff;
}

  
</style>


<!-- certifique-se de que pdf.js j√° est√° carregado -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.13.216/pdf.min.js"></script>

  <link rel="manifest" href="manifest.json">
  <script>
    window.AppCasaRosa = window.AppCasaRosa || {};
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js').then(() => {
        console.log("‚úÖ Service Worker registrado com sucesso");
      });
    }
  </script>
 <style>
@media (max-width: 768px) {
  input, select, button {
    width: 100% !important;
    font-size: 1.1rem;
    margin-bottom: 0.5rem;
  }
  .card, .tabela-container {
    width: 100% !important;
  }
  #menuLateral {
    width: 100% !important;
    position: relative;
  }
  .dashboard-card {
    flex-direction: column;
    gap: 0.5rem;
  }
}
</style> 
</head>
<body>
  <h2 style="text-align:center; font-size:1.8rem; color:#dc3545; margin:1rem 0;">
    üìä Controle Pedidos Casa Rosa
  </h2>

  <!-- teu layout de cards acima das abas permanece igual -->
<div style="text-align:right; margin:1rem;">
  <button onclick="AppCasaRosa.alternarTema()" style="padding:0.5rem 1rem;" id="btnTema">üåô Modo Escuro</button>
</div>
<button onclick="AppCasaRosa.deslogarUsuario()">üö™ Sair</button>

  <div class="tabs">
    <div class="tab" onclick="abrirAba('dashboard')"><i class="fas fa-chart-bar"></i> Dashboard</div>
<div class="tab active" onclick="abrirAba('importados')"><i class="fas fa-file-import"></i> Importados</div>
<div class="tab" onclick="abrirAba('enviados')"><i class="fas fa-truck"></i> Enviados</div>
<div class="tab" onclick="abrirAba('a_enviar')"><i class="fas fa-clock"></i> A Enviar</div>
<div class="tab" onclick="abrirAba('cancelados')"><i class="fas fa-ban"></i> Cancelados</div>
<div class="tab" onclick="abrirAba('etiquetas_pdf')"><i class="fas fa-file-pdf"></i> Etiquetas</div>
<div class="tab" onclick="abrirAba('aba-metas'); AppCasaRosa.preencherLojasInputMeta(); AppCasaRosa.preencherFiltroLojaMetas(); AppCasaRosa.atualizarRelatorioMetas(); AppCasaRosa.renderizarMetasManuais();">  <i class="fas fa-bullseye"></i> Metas Di√°rias
</div>
<div class="tab" onclick="abrirAba('aba-skus-equivalentes'); AppCasaRosa.carregarSkusEquivalentes();">
  <i class="fas fa-code-branch"></i> SKUs Equivalentes
</div>
 <div class="tab" onclick="abrirAba('aba-produtos'); AppCasaRosa.carregarProdutos();">  <i class="fas fa-box"></i> Produtos
</div>
<div class="tab" onclick="abrirAba('aba-logs'); AppCasaRosa.carregarLogs();">  <i class="fas fa-clipboard-list"></i> Logs
</div>
<div class="tab" onclick="abrirAba('aba-admin'); AppCasaRosa.preencherFiltroLojaMetas(); AppCasaRosa.atualizarRelatorioMetas(); AppCasaRosa.carregarProdutos(); AppCasaRosa.atualizarCardsMetas();">  <i class="fas fa-user-shield"></i> Administrador</div>
  </div>
<div id="login" style="display:flex; flex-direction:column; gap:1rem; max-width:400px; margin:5rem auto;">
  <h2>üîê Login</h2>
  <input type="email" id="emailLogin" placeholder="Email" style="padding:0.5rem;" />
  <input type="password" id="senhaLogin" placeholder="Senha" style="padding:0.5rem;" />
<button onclick="AppCasaRosa.fazerLogin()" style="padding:0.5rem;">Entrar</button>
  <div id="erroLogin" style="color:red;"></div>
</div>
<div id="sistema" style="display:none;">

  <!-- Pedidos Importados -->
  <div id="importados" class="tab-content active">
    <h2>üì• Importar Planilhas da Shopee</h2>
    <p><strong>Novos a Enviar:</strong><br>
      <input type="file" id="arquivoEnviar" accept=".xlsx">
    </p>
    <p><strong>Pedidos Enviados:</strong><br>
      <input type="file" id="arquivoEnviados" accept=".xlsx">
    </p>
    <p><strong>Filtrar por data:</strong><br>
      <input type="date" id="filtroData">
    </p>
    <button onclick="AppCasaRosa.processarArquivos()">üì• Importar e Comparar</button>
<button onclick="AppCasaRosa.apagarTudo()" style="background:red;color:white;font-weight:bold;">üß® Apagar TODOS os dados</button>
<button onclick="AppCasaRosa.removerPendentesJaEnviados()">...</button>
  <button onclick="AppCasaRosa.verificarEDeduplicarPedidos()" style="background:#ffc107;color:#000;font-weight:bold;">üîç Verificar e Limpar Duplicados</button>

    <hr style="margin:2rem 0;">
      </div>

  <!-- PDFs de Etiquetas -->
  <div id="etiquetas_pdf" class="tab-content">
  <h2>üìÇ PDFs de Etiquetas</h2>
  <p><strong>Selecionar PDF:</strong><br>
<input type="file" id="inputPDF" accept="application/pdf">
  </p>
  <button onclick="AppCasaRosa.processarPDF()">üì¶ Ler e Registrar</button>

  <ul id="listaPDFs"></ul>
</div>

  <!-- Pedidos Enviados -->
  <div id="enviados" class="tab-content">
    <h2>‚úÖ Pedidos Enviados</h2>
    <div style="margin:1rem 0; display:flex; gap:1rem; flex-wrap:wrap; align-items:center;">
      <label><strong>üìÜ M√™s:</strong>
        <input type="month" id="filtroMesRelatorio">
      </label>
      <button onclick="AppCasaRosa.exportarRelatorioMensal()">üì§ CSV</button>
      <button onclick="AppCasaRosa.exportarRelatorioPDF()">üìÑ PDF</button>
    </div>
<div id="tabela-enviados"></div>
</div>
      </div>

  <!-- Novos a Enviar -->
  <div id="a_enviar" class="tab-content">
    <h2>üü° Novos a Enviar</h2>
<div style="text-align:right; margin-bottom: 1rem;">
  <button onclick="AppCasaRosa.alternarVisualizacaoPedidos()" id="btnVisualizacaoPedidos">
    üì¶ Visualizar como Cards
  </button>
</div>

<!-- üîç Filtro de m√∫ltiplas lojas -->
<div class="card-filtros">
  <label>üè™ Filtrar por Loja:</label>
<select id="filtroMultiloja" multiple onchange="AppCasaRosa.atualizarDashboardPendentes()"></select>
   <label>üîç Filtrar por Produto:</label>
<select id="filtroMultiproduto" multiple onchange="AppCasaRosa.atualizarDashboardPendentes()"></select>
  <div style="flex-basis: 100%;">
    <button onclick="
    document.getElementById('filtroMultiloja').selectedIndex = -1;
    document.getElementById('filtroMultiproduto').selectedIndex = -1;
    AppCasaRosa.atualizarDashboardPendentes();">
    üîÑ Limpar Filtros
</button>
  </div>
</div>
<hr style="border: none; height: 1px; background: #dee2e6; margin: 1.5rem 0;">
<!-- üìä Cards de Resumo -->
<div class="cards-status">
  <div class="card-status card-novos">
    <strong>üì¶ Total a Enviar Hoje:</strong><br/>
    <span id="resumo-total-enviar">0</span>
  </div>
  <div class="card-status card-atraso">
    <strong>‚è∞ Atrasados:</strong><br/>
    <span id="resumo-atrasados">0</span>
  </div>
  <div class="card-status card-risco">
    <strong>‚ö†Ô∏è Em risco:</strong><br/>
    <span id="resumo-risco">0</span>
  </div>
  <div class="card-status card-enviados">
    <strong>‚úÖ Enviados Hoje:</strong><br/>
    <span id="resumo-enviados-hoje">0</span>
  </div>
</div>
 <button onclick="AppCasaRosa.exportarPedidosAEnviar()" style="background:#0d6efd;color:white;margin-bottom:1rem;">
  üì• Exportar para Excel
</button> 
<div id="tabelaPendentes"></div>
 <div id="cardsPendentes" class="cards-pendentes" style="display:none;"></div>     
  </div>

  <!-- Pedidos Cancelados -->
  <div id="cancelados" class="tab-content">
    <h2 style="display:flex; justify-content:space-between; align-items:center;">
      ‚ùå Cancelados
      <button onclick="AppCasaRosa.exportarCanceladosCSV()" style="background:#0d6efd;color:#fff;border:none;padding:0.4rem 0.8rem;border-radius:5px;cursor:pointer;">
        ‚¨áÔ∏è CSV
      </button>
    </h2>
    <div style="overflow-x:auto;"><table id="tabela-cancelados">
      <thead>
        <tr>
          <th>Loja</th>
          <th>Motivo</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table></div>
  </div>
<!-- Aba: Pedidos Cancelados -->
<div id="cancelamentos-detalhados" class="tab-content">
  <h2>‚ùå Pedidos Cancelados</h2>

  <!-- M√©tricas -->
  <div style="display:flex; gap:2rem; flex-wrap:wrap; margin-bottom:1rem;">
    <div style="background:#fff3cd; border:1px solid #ffeeba; padding:1rem; border-radius:0.5rem;">
      <strong>üìÖ Cancelamentos Hoje:</strong><br/>
      <span id="cancelados-hoje">0</span>
    </div>
    <div style="background:#f8d7da; border:1px solid #f5c6cb; padding:1rem; border-radius:0.5rem;">
      <strong>üìÜ Cancelamentos no M√™s:</strong><br/>
      <span id="cancelados-mes">0</span>
    </div>
  </div>

  <!-- Gr√°fico de Cancelamentos por Dia -->
  <div style="margin-top:2rem;">
    <h3>üìà Cancelamentos por Dia (m√™s atual)</h3>
    <canvas id="graficoCanceladosDia" height="100"></canvas>
  </div>

  
</div>

<!-- Dashboard Geral -->
<div id="dashboard" class="tab-content">
  <div class="dashboard-header">
    <h2>üìä Dashboard Geral</h2>
  </div>
<div style="text-align:right; margin-bottom: 1rem;">
  <button onclick="AppCasaRosa.alternarVisualizacaoPedidos()" id="btnVisualizacaoPedidos">
    üì¶ Visualizar como Cards
  </button>
</div>

  <!-- Filtros -->
  <div class="filtros-dashboard">
    <label>
      üìÖ Data:
  <input type="date" id="filtroDataDashboard" onchange="AppCasaRosa.atualizarDashboardPorDataLoja()" />
    </label>
    <label>
      üìä M√™s:
        <input type="month" id="filtroMesDashboard" onchange="AppCasaRosa.atualizarDashboardPorDataLoja()" />
    </label>
    <label>
       <input type="checkbox" id="filtroMesInteiroDashboard" onchange="AppCasaRosa.atualizarDashboardPorDataLoja()" />
      üîÑ Considerar m√™s inteiro
    </label>
    <label>
      üè™ Loja:
      <select id="filtroLojaDashboard" onchange="AppCasaRosa.atualizarDashboardPorDataLoja()">
        <option value="">Todas</option>
      </select>
    </label>
  </div>

  <!-- Cards de Resumo -->
  <div class="cards-status">
    <div class="card-status card-novos">
      <span>üì¶ Novos A Enviar:</span>
      <div id="valor-a-enviar-dashboard">0</div>
    </div>
    <div class="card-status card-enviados">
      <span>‚úÖ Enviados no m√™s:</span>
      <div id="valor-enviados-dashboard">0</div>
    </div>
    <div class="card-status card-comatraso">
      <span>üö® Enviados com Atraso:</span>
      <div id="valor-enviados-atraso-dashboard">0</div>
    </div>
    <div class="card-status card-atraso">
      <span>‚è∞ Atrasados:</span>
      <div id="valor-atrasados-dashboard">0</div>
    </div>
    <div class="card-status card-risco">
      <span>‚ö†Ô∏è Em risco:</span>
      <div id="valor-risco-dashboard">0</div>
    </div>
<div class="card-status card-percentual-atraso">
  <strong>üìâ % Atrasados:</strong><br />
  <span id="percentual-atrasados">0%</span>
</div>
  </div>
<!-- Filtro por produto -->
<div style="margin-top:1rem;">
  <label for="filtroProdutoDashboard">üîç Filtrar por produto:</label>
  <select id="filtroProdutoDashboard" multiple style="width:100%; max-width:400px;"></select>
</div>

  <!-- Pe√ßas Vendidas no M√™s -->
  <div id="card-vendas-mensais" style="background:#f8f9fa; border:1px solid #dee2e6; padding:1.5rem; border-radius:0.75rem; margin-top:1.5rem;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
      <h3 style="margin:0; color:#343a40;">üì¶ Pe√ßas Vendidas no M√™s:</h3>
      <div>
        <button onclick="AppCasaRosa.exportarVendasCSV()" style="margin-right:0.5rem;">üì• CSV</button>
        <button onclick="AppCasaRosa.exportarVendasPDF()">üìÑ PDF</button>
      </div>
    </div>
    <div id="vendas-por-produto" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:1rem;"></div>
  </div>
<h3 style="margin-top:2rem;">üìà Vendas por Dia no M√™s</h3>
<div style="position:relative; height:300px;">
  <canvas id="graficoVendasPorDia"></canvas>
</div>
<div style="display:flex; align-items:center; justify-content:space-between; margin-top:2rem;">
  <h3 style="margin:0;">üèÜ Comparativo de Vendas</h3>
  <select id="tipoComparativo" onchange="renderizarGraficoTopComparativo()" style="padding:0.25rem 0.5rem;">
    <option value="produtos">Produtos Mais Vendidos</option>
    <option value="lojas">Lojas com Mais Pedidos</option>
  </select>
</div>
<div style="position:relative; height:300px;">
  <canvas id="graficoTopProdutos"></canvas>
</div>

<!-- üìà Gr√°fico de M√©dia Di√°ria de Vendas -->
<div id="grafico-media-vendas" style="margin-top:2rem;">
  <h3>üìà M√©dia Di√°ria de Vendas</h3>
  <div style="margin-bottom:1rem;">
    <label><input type="radio" name="tipoMedia" value="produto" checked onchange="gerarGraficoMediaVendas()"> Por Produto</label>
    <label style="margin-left:1rem;"><input type="radio" name="tipoMedia" value="loja" onchange="gerarGraficoMediaVendas()"> Por Loja</label>
  </div>
  <div style="position:relative; height:300px;">
    <canvas id="graficoMediaPorDia"></canvas>
  </div>
</div>

<h3 style="margin-top:2rem;">‚è±Ô∏è Tempo M√©dio de Envio por Loja</h3>
<div style="position:relative; height:300px;">
  <canvas id="graficoTempoEnvio"></canvas>
</div>
<h3 style="margin-top:2rem;">üìà Relat√≥rio por Loja + Produto</h3>
<div id="tabela-detalhada-vendas" style="overflow-x:auto; margin-bottom:2rem;"></div>
<button onclick="AppCasaRosa.exportarRelatorioDetalhadoCSV()">üìÖ Exportar CSV</button>
<button onclick="AppCasaRosa.exportarRelatorioDetalhadoPDF()">üìÑ Exportar PDF</button>

  <!-- Gr√°fico de Status e Lembrete -->
  <div style="display:flex; gap:2rem; flex-wrap:wrap; justify-content:center; margin-top:2rem;">
    <div style="width:300px;">
      <canvas id="graficoStatus"></canvas>
    </div>
    <div id="lembreteUrgente" style="flex:1; min-width:300px; background:#fff3cd; border:1px solid #ffeeba; padding:1rem; border-radius:0.5rem;">
      <h3>‚ö†Ô∏è Lembrete Inteligente</h3>
      <p id="textoLembrete">Analisando pedidos...</p>
    </div>
  </div>
</div>
<div id="aba-skus-equivalentes" class="tab-content" style="padding:1rem;">
  <h2>üß© Cadastro de SKUs Equivalentes</h2>

  <form id="formSkus" onsubmit="salvarSkuEquivalente(event)">
    <label><strong>SKU Base:</strong></label><br />
    <input type="text" id="skuBase" required style="margin-bottom:0.5rem;width:200px;" /><br />
    
    <label><strong>SKUs Equivalentes (separados por v√≠rgula):</strong></label><br />
    <input type="text" id="skusEquivalentes" placeholder="Ex: A11, A11-KIT, A11-REDONDO" required style="width:300px;" /><br />
    
    <button type="submit" style="margin-top:1rem;">‚ûï Salvar Agrupamento</button>
  </form>

  <h3 style="margin-top:2rem;">üßæ Agrupamentos Salvos</h3>
  <div style="overflow-x:auto;"><table border="1" cellpadding="5" id="tabelaSkus" style="border-collapse:collapse;margin-top:0.5rem;width:100%;">
    <thead>
      <tr style="background:#f0f0f0;"><th>SKU Base</th><th>Equivalentes</th><th>A√ß√µes</th></tr>
    </thead>
    <tbody></tbody>
  </table></div>
</div>

<!-- üéØ Aba de Metas Manuais -->
<div id="aba-metas" class="tab-content">
  <h2>üéØ Cadastro Manual de Metas por Loja</h2>

  <form onsubmit="adicionarMetaManual(event)" style="display:flex; flex-wrap:wrap; gap:1rem; align-items:flex-end;">
    <div>
      <label>üè™ Lojas:</label><br />
      <select id="inputLojasMeta" multiple required style="width:220px; height:90px;"></select>
    </div>
    <div>
      <label>üì¶ Produto:</label><br />
      <input type="text" id="inputProdutoMeta" required style="width:200px;" />
    </div>
    <div>
      <label>üéØ Meta Mensal:</label><br />
      <input type="number" id="inputValorMeta" required style="width:120px;" min="0" />
    </div>
    <div>
      <label>üìÖ M√™s:</label><br />
      <input type="month" id="inputMesMeta" required style="width:150px;" />
    </div>
    <button type="submit" style="background:#198754; color:white; padding:0.5rem 1rem; border:none; border-radius:6px;">
      ‚ûï Adicionar Meta
    </button>
  </form>

  <hr style="margin:1.5rem 0; border: none; border-top: 1px solid #ccc;" />

  <h3>üìã Metas Cadastradas</h3>
  <div id="containerMetasCards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;"></div>
</div>
  
<div id="aba-produtos" class="tab-content" style="padding:1rem;">
  <h2>üì¶ Cadastro de Produtos</h2>
  <form id="formProduto" onsubmit="salvarProduto(event)" style="margin-bottom:1rem;">
    <label>Nome do Produto:</label><br />
    <input type="text" id="nomeProduto" required style="width:200px; margin-bottom:0.5rem;" /><br />
    <label>Sobra Ideal:</label><br />
    <input type="number" id="sobraIdeal" required style="width:120px;" min="0" /><br />
    <label>Valor:</label><br />
    <input type="number" id="valorProduto" required style="width:120px;" min="0" step="0.01" /><br />
    <button type="submit" style="margin-top:0.5rem;">‚ûï Salvar</button>
  </form>
  </div>
<div id="aba-logs" class="tab-content" style="padding:2rem;">
  <h2>üïµÔ∏è Registro de A√ß√µes</h2>
  <div id="tabelaLogs" style="margin-top:1rem;"></div>
</div>

<div id="aba-admin" class="tab-content" style="padding:1rem;">
  <h2 style="margin:2rem 0 1rem;">üìä Acompanhamento de Metas</h2>
  <div id="container-cards-metas" style="display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:1rem;"></div>
  <h2 style="margin:2rem 0 1rem;">üìà Vendas por Loja</h2>
  <div class="filtros-dashboard">
    <label>
      üìÖ Data:
      <input type="date" id="filtroDataMetas" onchange="AppCasaRosa.atualizarRelatorioMetas()" />
    </label>
    <label>
      <input type="checkbox" id="filtroMesInteiroMetas" onchange="AppCasaRosa.atualizarRelatorioMetas()" />
      üîÑ Considerar m√™s inteiro
    </label>
    <label>
      üè™ Loja:
      <select id="filtroLojaMetas" onchange="AppCasaRosa.atualizarRelatorioMetas()">
        <option value="">Todas</option>
      </select>
    </label>
  </div>
  <div id="tabela-vendas-metas" style="margin-top:1rem;"></div>
  <h3>Produtos Salvos</h3>
  <div style="overflow-x:auto;">
    <table border="1" cellpadding="5" id="tabelaProdutos" style="border-collapse:collapse; width:100%;">
      <thead>
        <tr style="background:#f0f0f0;"><th>Produto</th><th>Sobra Ideal</th><th>Valor</th><th>A√ß√µes</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>



  <script>
    window.AppCasaRosa = window.AppCasaRosa || {};
  // Alterna abas do sistema
  function abrirAba(id) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelector('.tab[onclick*="' + id + '"]').classList.add('active');
    document.getElementById(id).classList.add('active');

    if (id === "dashboard") {
       AppCasaRosa.atualizarDashboardPorDataLoja();
      AppCasaRosa.atualizarResumoVendasMensal();
      AppCasaRosa.preencherFiltroLojaDashboard();
      AppCasaRosa.gerarResumoVendasPorProduto();
      AppCasaRosa.preencherFiltroProdutosDashboard();
      AppCasaRosa.renderizarGraficoVendasPorDia();
      AppCasaRosa.renderizarGraficoTopComparativo();
      AppCasaRosa.renderizarGraficoTempoEnvio();
      AppCasaRosa.gerarRelatorioDetalhado();
    } else if (id === "aba-metas") {
       AppCasaRosa.preencherFiltroLojaMetas();
      AppCasaRosa.atualizarRelatorioMetas();
    } else if (id === "aba-produtos") {
      AppCasaRosa.carregarProdutos();
    } else if (id === "aba-admin") {
      AppCasaRosa.preencherFiltroLojaMetas();
      AppCasaRosa.atualizarRelatorioMetas();
      AppCasaRosa.carregarProdutos();
      AppCasaRosa.atualizarCardsMetas();
    }
  }
  // Retorna o primeiro campo definido em obj dentre a lista de keys
  function normalizarCampo(obj, campos) {
    for (const campo of campos) {
      if (obj[campo]) return obj[campo];
    }
    return "";
  }
AppCasaRosa.atualizarResumoVendasMensal = function() {
  const enviados = AppCasaRosa.enviadosList || [];
  const mesSelecionado  = document.getElementById("filtroMesDashboard")?.value;
  const lojaSelecionada = document.getElementById("filtroLojaDashboard")?.value;

  // ‚úÖ Fun√ß√£o para obter SKU base
  AppCasaRosa.obterSkuBase = function(sku) {
    const equivalents = AppCasaRosa.skusEquivalentes || {};
    for (const [base, aliases] of Object.entries(equivalents)) {
      if (base === sku || (Array.isArray(aliases) && aliases.includes(sku))) {
        return base;
      }
    }
    return sku;
  };

  const resumo = {};

  enviados.forEach(p => {
    if (!p.dataEnvio) return;
    const dt = new Date(p.dataEnvio.split("T")[0]);
    if (!dt || isNaN(dt)) return;

    const dataStr = `${dt.getFullYear()}-${String(dt.getMonth() + 1).padStart(2, "0")}`;
    if (mesSelecionado && dataStr !== mesSelecionado) return;

    const loja = p.Loja || "";
    if (lojaSelecionada && loja !== lojaSelecionada) return;

    const skuBase = AppCasaRosa.obterSkuBase(p.SKU || "Desconhecido");
    resumo[skuBase] = (resumo[skuBase] || 0) + 1;
  });

  const saida = Object.entries(resumo)
    .sort((a, b) => b[1] - a[1])
    .map(
      ([produto, qtd]) =>
        `<div style="padding: 0.2rem 0;">‚Ä¢ <strong>${produto}</strong>: ${qtd}</div>`
    )
    .join("");

  const vendasContainer = document.getElementById("vendas-por-produto");
  if (vendasContainer) {
    vendasContainer.innerHTML = saida || "<i style='color:#888'>Nenhuma venda no per√≠odo.</i>";
  }
};


  // L√™ um arquivo .xlsx e passa o JSON da primeira planilha ao callback
  function lerArquivo(input, callback) {
    const reader = new FileReader();
    reader.onload = (e) => {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sheet);
      callback(json);
    };
    reader.readAsArrayBuffer(input.files[0]);
  }

async function processarArquivos() {
  const inputEnviar = document.getElementById('arquivoEnviar');
  const inputEnviados = document.getElementById('arquivoEnviados');

  const enviarTemArquivo = inputEnviar?.files.length > 0;
  const enviadosTemArquivo = inputEnviados?.files.length > 0;

  if (!enviarTemArquivo && !enviadosTemArquivo) {
    alert("Por favor, selecione pelo menos um arquivo para importar.");
    return;
  }

  // Carrega todos os pedidos existentes para evitar duplicidade
  const [pendentesSnap, enviadosSnap, canceladosSnap] = await Promise.all([
    AppCasaRosa.getDocs(AppCasaRosa.collection(AppCasaRosa.db, "pedidos_pendentes")),
    AppCasaRosa.getDocs(AppCasaRosa.collection(AppCasaRosa.db, "pedidos_enviados")),
    AppCasaRosa.getDocs(AppCasaRosa.collection(AppCasaRosa.db, "pedidos_cancelados")),
  ]);

  const idsExistentes = new Set();
  [...pendentesSnap.docs, ...enviadosSnap.docs, ...canceladosSnap.docs].forEach(doc => {
    const id = doc.data().pedidoId || doc.data().Pedido || "";
    idsExistentes.add(id.toString().trim().toUpperCase());
  });

  // ‚îÄ‚îÄ‚îÄ IMPORTAR "A ENVIAR" ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (enviarTemArquivo) {
    await new Promise(resolve => {
      lerArquivo(inputEnviar, async dadosEnviar => {
        for (const p of dadosEnviar) {
          const pedidoId = normalizarCampo(p, ["N¬∫ de Pedido da Plataforma"]).toString().trim().toUpperCase();
          if (!pedidoId || idsExistentes.has(pedidoId)) continue;

          const statusPosVenda = normalizarCampo(p, ["P√≥s-venda/Cancelado/Devolvido", "P√≥s-venda"]);
          const horaEnvio = normalizarCampo(p, ["Hora de Envio"]);

          const baseDoc = {
            pedidoId,
            Loja: normalizarCampo(p, ["Loja", "Nome da Loja no UpSeller"]),
            SKU: normalizarCampo(p, ["SKU"]),
            Rastreio: normalizarCampo(p, ["N¬∫ de Rastreio", "C√≥digo de Rastreio"]),
            dataPagamento: p["Impress√£o da Etiqueta"]
              ? new Date(p["Impress√£o da Etiqueta"]).toISOString()
              : new Date().toISOString(),
            status: "novo"
          };

          try {
            if (statusPosVenda?.toLowerCase().includes("cancelado")) {
              await AppCasaRosa.addDoc(AppCasaRosa.collection(AppCasaRosa.db, "pedidos_cancelados"), {
                ...baseDoc,
                motivo: "Cancelado automaticamente via planilha",
                dataCancelamento: new Date().toISOString()
              });
              console.log("üì¶ Pedido cancelado:", pedidoId);
            } else if (horaEnvio && !isNaN(new Date(horaEnvio))) {
              await AppCasaRosa.addDoc(AppCasaRosa.collection(AppCasaRosa.db, "pedidos_enviados"), {
                ...baseDoc,
                dataEnvio: new Date(horaEnvio).toISOString()
              });
              console.log("‚úÖ Pedido enviado:", pedidoId);
            } else {
              await AppCasaRosa.addDoc(AppCasaRosa.collection(AppCasaRosa.db, "pedidos_pendentes"), baseDoc);
              console.log("üïí Pedido pendente:", pedidoId);
            }
          } catch (erro) {
            console.error("‚ùå Erro ao salvar pedido:", pedidoId, erro);
          }
        }

        alert("‚úÖ Pedidos 'a enviar' importados com sucesso!");
        resolve();
      });
    });
  }

  // ‚îÄ‚îÄ‚îÄ IMPORTAR "ENVIADOS" ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (enviadosTemArquivo) {
    await new Promise(resolve => {
      lerArquivo(inputEnviados, async dadosEnviados => {
        console.log("üì¶ Dados da planilha ENVIADOS:", dadosEnviados);

        for (const pedido of dadosEnviados) {
          const pedidoId = normalizarCampo(pedido, [
            "N¬∫ de Pedido da Plataforma",
            "N√∫mero do Pedido",
            "Pedido",
            "ID do Pedido"
          ]).toString().trim().toUpperCase();

          if (!pedidoId) continue;

          const loja = normalizarCampo(pedido, ["Loja", "Nome da Loja no UpSeller"]);
          const sku = normalizarCampo(pedido, ["SKU", "Produto"]);
          const rastreio = normalizarCampo(pedido, ["C√≥digo de Rastreio", "Rastreio", "N¬∫ de Rastreio"]);
          const pagRaw = normalizarCampo(pedido, ["Data de Pagamento", "Impress√£o da Etiqueta"]);
          const envioRaw = normalizarCampo(pedido, ["Hora de Envio"]);

          const dataPagamento = pagRaw && !isNaN(new Date(pagRaw)) ? new Date(pagRaw).toISOString() : null;
          const dataEnvio = envioRaw && !isNaN(new Date(envioRaw)) ? new Date(envioRaw).toISOString() : new Date().toISOString();

          try {
            const enviadoJaExiste = enviadosSnap.docs.some(d => (d.data().pedidoId || "").toUpperCase() === pedidoId);
            const canceladoJaExiste = canceladosSnap.docs.some(d => (d.data().pedidoId || "").toUpperCase() === pedidoId);

            if (enviadoJaExiste || canceladoJaExiste) {
              console.warn("‚è≠Ô∏è Ignorado (j√° enviado ou cancelado):", pedidoId);
              continue;
            }

            const pendenteDoc = pendentesSnap.docs.find(d => (d.data().pedidoId || "").toUpperCase() === pedidoId);
            if (pendenteDoc) {
              await AppCasaRosa.deleteDoc(AppCasaRosa.doc(AppCasaRosa.db, "pedidos_pendentes", pendenteDoc.id));
              console.log("üßπ Removido de pendentes:", pedidoId);
            }

            await AppCasaRosa.addDoc(AppCasaRosa.collection(AppCasaRosa.db, "pedidos_enviados"), {
              pedidoId,
              Loja: loja,
              SKU: sku,
              Rastreio: rastreio,
              dataPagamento,
              dataEnvio,
              status: "enviado"
            });

            console.log("‚úÖ Pedido enviado salvo:", pedidoId);
          } catch (erro) {
            console.error("‚ùå Erro ao salvar pedido:", pedidoId, erro);
          }
        }

        alert("‚úÖ Pedidos ENVIADOS importados com sucesso!");
        await carregarEnviadosFirebase();
        resolve();
      });
    });
  }
}

// üß© REGISTRA A FUN√á√ÉO PARA O HTML USAR
AppCasaRosa.processarArquivos = processarArquivos;

async function carregarEnviadosFirebase() {
  const snap = await AppCasaRosa.getDocs(AppCasaRosa.collection(AppCasaRosa.db, "pedidos_enviados"));
  const hoje = new Date();
  const tresDiasAtras = new Date();
  tresDiasAtras.setDate(hoje.getDate() - 3);

  const todos = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  const recentes = todos.filter(p => {
    if (!p.dataEnvio) return false;
    const dt = new Date(p.dataEnvio.split("T")[0]);
    return dt >= tresDiasAtras;
  });

  AppCasaRosa.enviadosList = recentes;

  atualizarTabelas();
  gerarGraficoMediaVendas();
}

// ‚úÖ Cole esta em seu lugar:
// Cancela um pedido: atualiza status no pedido original e registra em ‚Äúpedidos_cancelados‚Äù
async function cancelarPedido(pedidoId) {
  const motivo = prompt("Digite o motivo do cancelamento:");
  if (!motivo) return;

  try {
    const pedidoRef = doc(db, "pedidos_pendentes", pedidoId);
    const snapshot = await getDoc(pedidoRef);

    if (!snapshot.exists()) {
      alert("Pedido n√£o encontrado.");
      return;
    }

    const dadosPedido = snapshot.data();

    // Remove o pedido da cole√ß√£o de pendentes
    await deleteDoc(pedidoRef);

    // Registra o pedido completo como cancelado
    await addDoc(collection(db, "pedidos_cancelados"), {
      ...dadosPedido,
      pedidoId,
      motivo,
      dataCancelamento: new Date().toISOString()
    });

    alert("Pedido cancelado com sucesso.");
  } catch (error) {
    console.error("Erro ao cancelar o pedido:", error);
    alert("Erro ao cancelar o pedido.");
  }
}
window.AppCasaRosa = window.AppCasaRosa || {};

window.AppCasaRosa.atualizarDashboardPorDataLoja = function() {
  const enviados = window.AppCasaRosa.enviadosList || [];
  const pendentes = window.AppCasaRosa.importadosList || [];

  const dataSelecionadaStr = document.getElementById("filtroDataDashboard").value;
  const considerarMes = document.getElementById("filtroMesInteiroDashboard").checked;
  const lojaSelecionada = document.getElementById("filtroLojaDashboard").value;
  const mesSelecionadoStr = document.getElementById("filtroMesDashboard")?.value;
  const [anoDash, mesDash] = mesSelecionadoStr ? mesSelecionadoStr.split("-").map(Number) : [];
  const dataSelecionada = dataSelecionadaStr ? new Date(dataSelecionadaStr) : null;
  const ano = dataSelecionada ? dataSelecionada.getFullYear() : null;
  const mes = dataSelecionada ? dataSelecionada.getMonth() + 1 : null;

  let totalEnviar = 0, totalEnviados = 0, totalAtrasados = 0, totalRisco = 0, enviadosComAtraso = 0;

  // üëâ C√°lculo para pendentes
  pendentes.forEach(e => {
    const loja = (e.Loja || "").trim();
    const pagStr = e.dataPagamento?.split("T")[0];
    if (!pagStr) return;

    const pag = new Date(pagStr);
    if (isNaN(pag)) return;

    if (lojaSelecionada && loja !== lojaSelecionada) return;
    if (mesSelecionadoStr) {
      if (pag.getFullYear() !== anoDash || (pag.getMonth() + 1) !== mesDash) return;
    } else if (dataSelecionada) {
      if (considerarMes) {
        if (pag.getFullYear() !== ano || (pag.getMonth() + 1) !== mes) return;
      } else {
        if (pag.toDateString() !== dataSelecionada.toDateString()) return;
      }
    }

    const uteis = calcularDiasUteis(pag, new Date());
    totalEnviar++;
    if (calcularHorasUteis(pag, new Date()) > 36) totalAtrasados++;
    else if (uteis === 1) totalRisco++;
  });

  // üëâ C√°lculo para enviados
  enviados.forEach(p => {
    const loja = (p.Loja || "").trim();
    const envioStr = p.dataEnvio?.split("T")[0];
    const pagStr   = p.dataPagamento?.split("T")[0];
    if (!envioStr || !pagStr) return;

    const envio = new Date(envioStr);
    const pag   = new Date(pagStr);
    if (isNaN(envio) || isNaN(pag)) return;

    if (lojaSelecionada && loja !== lojaSelecionada) return;
    if (mesSelecionadoStr) {
      if (envio.getFullYear() !== anoDash || (envio.getMonth() + 1) !== mesDash) return;
    } else if (dataSelecionada) {
      if (considerarMes) {
        if (envio.getFullYear() !== ano || (envio.getMonth() + 1) !== mes) return;
      } else {
        if (envio.toDateString() !== dataSelecionada.toDateString()) return;
      }
    }

    totalEnviados++;
    const horasUteis = calcularHorasUteis(pag, envio);
    const atraso = horasUteis > 36;
    if (atraso) enviadosComAtraso++;
  });

  // üëâ Atualiza os cards no DOM
  document.getElementById("valor-a-enviar-dashboard").textContent         = totalEnviar;
  document.getElementById("valor-enviados-dashboard").textContent        = totalEnviados;
  document.getElementById("valor-atrasados-dashboard").textContent       = totalAtrasados;
  document.getElementById("valor-risco-dashboard").textContent           = totalRisco;
  document.getElementById("valor-enviados-atraso-dashboard").textContent = enviadosComAtraso;

  const percentual = totalEnviados > 0
    ? ((enviadosComAtraso / totalEnviados) * 100).toFixed(1) + "%"
    : "0%";

  document.getElementById("percentual-atrasados").textContent = percentual;

  // Chame as outras fun√ß√µes (elas tamb√©m precisam estar no global se forem usadas em eventos)
  if (typeof window.AppCasaRosa.atualizarResumoPedidosAEviar === "function") window.AppCasaRosa.atualizarResumoPedidosAEviar();
  if (typeof window.AppCasaRosa.atualizarResumoVendasMensal === "function") window.AppCasaRosa.atualizarResumoVendasMensal();
  if (typeof window.AppCasaRosa.gerarResumoVendasPorProduto === "function") window.AppCasaRosa.gerarResumoVendasPorProduto();
  if (typeof window.AppCasaRosa.preencherFiltroProdutosDashboard === "function") window.AppCasaRosa.preencherFiltroProdutosDashboard();
  if (typeof window.AppCasaRosa.renderizarGraficoVendasPorDia === "function") window.AppCasaRosa.renderizarGraficoVendasPorDia();
  if (typeof window.AppCasaRosa.renderizarGraficoTopComparativo === "function") window.AppCasaRosa.renderizarGraficoTopComparativo();
  if (typeof window.AppCasaRosa.renderizarGraficoTempoEnvio === "function") window.AppCasaRosa.renderizarGraficoTempoEnvio();
  if (typeof window.AppCasaRosa.gerarRelatorioDetalhado === "function") window.AppCasaRosa.gerarRelatorioDetalhado();
};

function atualizarTabelas() {
  const importar    = AppCasaRosa.importadosList  || [];
  const enviados    = AppCasaRosa.enviadosList    || [];
  const cancelados  = AppCasaRosa.canceladosList  || [];
  const historico   = AppCasaRosa.historicoList   || [...importar, ...enviados];

  const filtroData    = document.getElementById("filtroData")?.value;
  const lojaFiltro    = document.getElementById("filtroLoja")?.value.toLowerCase()  || "";
  const produtoFiltro = document.getElementById("filtroProduto")?.value.toLowerCase() || "";

  const enviadosSet = new Set(
    enviados.map(p =>
      normalizarCampo(p, ["pedidoId", "Pedido"])
        .toString().trim()
    )
  );

  const pendentes = importar.filter(p =>
    !enviadosSet.has(
      normalizarCampo(p, ["N¬∫ de Pedido da Plataforma", ])
        .toString().trim()
    )
  );

  const enviadosFiltrados = enviados.filter(p => {
    if (filtroData) {
      const dataStr = p.dataEnvio?.split("T")[0];
      if (dataStr !== filtroData) return false;
    }
    const loja = (p.Loja || "").toLowerCase();
    if (lojaFiltro && loja !== lojaFiltro) return false;
    return true;
  });

  const pendentesFiltrados = pendentes.filter(p => {
    const loja = normalizarCampo(p, ["Loja", "Nome da Loja no UpSeller"]).toLowerCase();
    const sku = AppCasaRosa.obterSkuPrincipal(p.SKU || "Desconhecido");
    if (lojaFiltro && loja !== lojaFiltro) return false;
    if (produtoFiltro && sku !== produtoFiltro) return false;
    return true;
  });

  renderTabela("tabelaPendentes",  pendentesFiltrados);
  renderTabela("tabelaEnviados",   enviadosFiltrados);
  renderTabela("tabelaHistorico",  historico);
  renderTabela("tabelaCancelados", cancelados);

  if (typeof AppCasaRosa.atualizarResumoCancelados === "function") AppCasaRosa.atualizarResumoCancelados();
  if (typeof AppCasaRosa.gerarGraficoCancelados === "function") AppCasaRosa.gerarGraficoCancelados();
  if (typeof AppCasaRosa.atualizarDashboardPorDataLoja === "function") AppCasaRosa.atualizarDashboardPorDataLoja();
  if (typeof AppCasaRosa.atualizarResumoVendasMensal === "function") AppCasaRosa.atualizarResumoVendasMensal();
  if (typeof AppCasaRosa.gerarResumoVendasPorProduto === "function") AppCasaRosa.gerarResumoVendasPorProduto();
  if (typeof AppCasaRosa.preencherFiltroProdutosDashboard === "function") AppCasaRosa.preencherFiltroProdutosDashboard();
  if (typeof AppCasaRosa.renderizarGraficoVendasPorDia === "function") AppCasaRosa.renderizarGraficoVendasPorDia();
  if (typeof AppCasaRosa.renderizarGraficoTopComparativo === "function") AppCasaRosa.renderizarGraficoTopComparativo();
  if (typeof AppCasaRosa.renderizarGraficoTempoEnvio === "function") AppCasaRosa.renderizarGraficoTempoEnvio();
  if (typeof AppCasaRosa.gerarRelatorioDetalhado === "function") AppCasaRosa.gerarRelatorioDetalhado();
}

// Exponha a fun√ß√£o no escopo global:
window.AppCasaRosa = window.AppCasaRosa || {};
window.AppCasaRosa.atualizarTabelas = atualizarTabelas;

// Preenche os filtros ao abrir a aba 'Novos a Enviar'
document.querySelector("div.tab[onclick=\"abrirAba('a_enviar')\"]").addEventListener("click", () => {
  const pendentes = AppCasaRosa.importadosList || [];
  const lojas = [...new Set(pendentes.map(p => p.Loja).filter(Boolean))].sort();
  const produtos = [...new Set(pendentes.map(p => AppCasaRosa.obterSkuPrincipal(p.SKU)).filter(Boolean))].sort();
  const selectLoja = document.getElementById("filtroMultiloja");
  const selectProduto = document.getElementById("filtroMultiproduto");

  selectLoja.innerHTML = lojas.map(l => `<option value="${l}">${l}</option>`).join("");
  selectProduto.innerHTML = produtos.map(p => `<option value="${p}">${p}</option>`).join("");

  if (typeof AppCasaRosa.atualizarDashboardPendentes === "function") AppCasaRosa.atualizarDashboardPendentes();
});
function calcularHorasUteis(dataInicio, dataFim) {
  let totalHoras = 0;
  const inicio = new Date(dataInicio);
  const fim = new Date(dataFim);

  inicio.setMinutes(0, 0, 0); // zera minutos e segundos
  fim.setMinutes(0, 0, 0);

  const current = new Date(inicio);
  while (current <= fim) {
    const diaSemana = current.getDay();
    if (diaSemana !== 0 && diaSemana !== 6) {
      totalHoras++;
    }
    current.setHours(current.getHours() + 1);
  }

  return totalHoras;
}
   function obterLojaPrincipal(p) {
  return (p.Loja || p["Nome da Loja no UpSeller"] || p["Nome da Loja"] || "").trim().toLowerCase();
} 

 function aplicarFiltroPedidos() {
  const todosPedidos       = AppCasaRosa.importadosList || [];
  const lojaSelecionada    = document.getElementById("filtroLoja")?.value || "";
  const produtoSelecionado = document.getElementById("filtroProduto")?.value || "";

  // Preenche os filtros com op√ß√µes √∫nicas
  const lojasUnicas = [...new Set(todosPedidos.map(p => p.Loja).filter(Boolean))];
  const produtosUnicos = [...new Set(todosPedidos.map(p => p.SKU).filter(Boolean))];

  const selectLoja = document.getElementById("filtroMultiloja");
  const selectProduto = document.getElementById("filtroMultiproduto");


  selectLoja.innerHTML = '<option value="">Todas</option>' +
    lojasUnicas.map(l => `<option value="${l}">${l}</option>`).join("");

  selectProduto.innerHTML = '<option value="">Todos</option>' +
    produtosUnicos.map(p => `<option value="${p}">${p}</option>`).join("");

  // Aplica o filtro
  const filtrados = todosPedidos.filter(p => {
    const loja    = p.Loja || "";
const sku = AppCasaRosa.obterSkuPrincipal(p.SKU || "Desconhecido");
    const lojaOk    = !lojaSelecionada    || loja    === lojaSelecionada;
    const produtoOk = !produtoSelecionado || produto === produtoSelecionado;
    return lojaOk && produtoOk;
  });

  // Atualiza a tabela
  renderTabela("tabelaPendentes", filtrados);

}


  // Atualiza a lista de PDFs mostrando bot√µes de ‚ÄúVer‚Äù e ‚ÄúBaixar‚Äù
  function atualizarListaPDFs() {
    const lista = document.getElementById("listaPDFs");
    const pdfs  = AppCasaRosa.pdfsList || [];
    if (!lista) return;

    lista.innerHTML = "";
    pdfs.forEach((pdf, i) => {
      const li = document.createElement("li");
      li.innerHTML = `
        üìé ${pdf.nome}
        <button onclick="AppCasaRosa.abrirPDF(${i})">üîç Ver</button>
        <button onclick="AppCasaRosa.baixarPDF(${i})">‚¨áÔ∏è Baixar</button>
      `;
      lista.appendChild(li);
    });
  }
      function renderTabela(destinoId, dados) {
  const container = document.getElementById(destinoId);
  if (!container) return;

  // helper para agrupar por data (campo ISO)
  function agruparPorData(lista, campo) {
    const grupos = {};
    lista.forEach(item => {
      const data = (item[campo] || item.dataEnvio || item.dataPagamento || "")
        .toString()
        .split("T")[0];
      if (!grupos[data]) grupos[data] = [];
      grupos[data].push(item);
    });
    return grupos;
  }

  // cabe√ßalhos e linhas por tipo de tabela
  let cols = [], rowsHtml = "";

  if (destinoId === "tabelaCancelados") {
    cols = ["Pedido", "Loja", "Produto", "Pagamento", "Rastreio", "Motivo"];
    dados.forEach(p => {
      const pedido   = normalizarCampo(p, ["pedidoId", "Pedido"]);
      const loja     = p.Loja || "";
      const produto  = p.SKU || "";
      const pag      = p.dataPagamento?.split("T")[0] || "";
      const rastreio = p.Rastreio || "";
      const motivo   = p.motivo || "-";
      rowsHtml += `<tr>
        <td>${pedido}</td>
        <td>${loja}</td>
        <td>${produto}</td>
        <td>${pag}</td>
        <td>${rastreio}</td>
        <td>${motivo}</td>
      </tr>`;
    });

    const thead = `<thead style="background:#dc3545;color:#fff;"><tr>${cols.map(h => `<th>${h}</th>`).join("")}</tr></thead>`;
    const tbody = `<tbody>${rowsHtml}</tbody>`;

    container.innerHTML = `
      <div style="overflow-x:auto; margin-top:1rem;">
        <div style="overflow-x:auto;"><table style="width:100%; border-collapse:collapse;">${thead}${tbody}</table></div>
      </div>
    `;
  }



  else if (destinoId === "tabelaEnviados") {
  cols = ["Pedido", "Loja", "Produto", "Rastreio", "Pagamento", "Data de Envio", "A√ß√µes"];
  const grupos = agruparPorData(dados, "dataEnvio");
  Object.keys(grupos).sort().forEach(data => {
    rowsHtml += `<tr style="background:#e9ecef;font-weight:bold;">
      <td colspan="${cols.length}">üì¶ ${data}</td>
    </tr>`;
    grupos[data].forEach(p => {
      const pedido   = normalizarCampo(p, ["pedidoId", "Pedido"]);
      const loja     = p.Loja || "";
      const produto  = p.SKU || "";
      const rastreio = p.Rastreio || "";
      const pag      = p.dataPagamento?.split("T")[0] || "-";
      const envio    = p.dataEnvio?.split("T")[0] || "-";
      rowsHtml += `<tr>
        <td>${pedido}</td>
        <td>${loja}</td>
        <td>${produto}</td>
        <td>${rastreio}</td>
        <td>${pag}</td>
        <td>${envio}</td>
        <td><button class="danger" onclick="cancelarPedido('${p.id}')">‚ùå Cancelar</button></td>
      </tr>`;
    });
  });
}


  else if (destinoId === "tabelaPendentes") {
  cols = ["Pedido", "Loja", "Produto", "Pagamento", "Rastreio", "A√ß√µes"];
  const grupos = agruparPorData(dados, "dataPagamento");
  Object.keys(grupos).sort().forEach(data => {
    rowsHtml += `<tr style="background:#e9ecef;font-weight:bold;">
      <td colspan="${cols.length}">üìÖ ${data}</td>
    </tr>`;
    grupos[data].forEach(p => {
      const pedido   = normalizarCampo(p, ["pedidoId", "Pedido"]);
      const loja     = p.Loja || "";
      const produto  = p.SKU || "";
      const pag      = p.dataPagamento?.split("T")[0] || "";
      const rastreio = p.Rastreio || "";
      const dias     = pag ? calcularDiasUteis(new Date(pag), new Date()) : 0;
      let style = "";
      if (dias >= 3) style = "background:#f8d7da;";
      else if (dias === 2) style = "background:#fff3cd;";
      rowsHtml += `<tr style="${style}">
        <td>${pedido}</td>
        <td>${loja}</td>
        <td>${produto}</td>
        <td>${pag}</td>
        <td>${rastreio}</td>
        <td><button class="danger" onclick="cancelarPedido('${p.id}')">‚ùå Cancelar</button></td>
      </tr>`;
    });
  });
}
  else if (destinoId === "tabelaHistorico") {
    cols = ["Pedido", "Loja", "Status", "Pagamento", "Envio"];
    dados.forEach(p => {
      const pedido = normalizarCampo(p, ["pedidoId", "Pedido"]);
      const loja   = p.Loja || "";
      const status = p.status || "";
      const pag    = p.dataPagamento?.split("T")[0] || "";
      const env    = p.dataEnvio?.split("T")[0] || "";
      rowsHtml += `<tr>
        <td>${pedido}</td>
        <td>${loja}</td>
        <td>${status}</td>
        <td>${pag}</td>
        <td>${env}</td>
      </tr>`;
    });
  }

  // monta o HTML completo
  const thead = `<thead><tr>${cols.map(h => `<th>${h}</th>`).join("")}</tr></thead>`;
  const tbody = `<tbody>${rowsHtml}</tbody>`;
  container.innerHTML = `
  <div style="overflow-x: auto; margin-top: 1rem;">
    <div style="overflow-x:auto;"><table style="width: 100%; border-collapse: collapse;">
      ${thead}
      ${tbody}
    </table></div>
  </div>`;


}

// Atualiza o card ‚Äú‚úÖ Enviados hoje‚Äù
function calcularDashboard() {
  const pendentesBase = AppCasaRosa.importadosList || [];
  const enviados      = AppCasaRosa.enviadosList   || [];
  const hoje          = new Date();
  hoje.setHours(0, 0, 0, 0);
  
// Filtros selecionados
  const mesSelecionado  = document.getElementById("filtroMesDashboard")?.value;
  const lojaSelecionada = document.getElementById("filtroLojaDashboard")?.value;
  const [anoSel, mesSel] = mesSelecionado?.split("-").map(Number) || [];
  
  function diasUteisEntre(dataInicial, dataFinal) {
    let count = 0;
    const current = new Date(dataInicial);
    while (current <= dataFinal) {
      const dia = current.getDay();
      if (dia !== 0 && dia !== 6) count++;
      current.setDate(current.getDate() + 1);
    }
    return count - 1;
  }

  const enviadosSet = new Set(enviados.map(p => (p.id || p.pedidoId || "").toString().trim()));

const pendentes = pendentesBase.filter(p => {
  const id = (p.id || p.pedidoId || "").toString().trim();
  const loja = (p.Loja || "").trim();

  if (enviadosSet.has(id)) return false;
  if (lojaSelecionada && loja !== lojaSelecionada) return false;
  return true;
});



  const totalAEnviar = pendentes.length;
  let atrasados = 0, quaseAtrasando = 0;

// Calcula atrasos considerando apenas os pendentes filtrados
  pendentes.forEach(p => {
    const pagStr = p.dataPagamento?.split("T")[0];
    if (!pagStr) return;
    const dataPag = new Date(pagStr);
    const uteis   = diasUteisEntre(dataPag, hoje);
    if (uteis >= 2) atrasados++;
    else if (uteis === 1) quaseAtrasando++;
  });

  const hojeStr = hoje.toISOString().split("T")[0];
  const enviadosHoje = enviados.filter(p => {
    const envStr = p.dataEnvio?.split("T")[0];
    const dataSelecionadaStr = document.getElementById("filtroDataDashboard")?.value;

  }).length;

  // Aplica filtros de m√™s e loja (se houver)
 

  const enviadosFiltradosNoMes = enviados.filter(p => {
    if (!p.dataEnvio) return false;
    const [ano, mes] = p.dataEnvio.split("T")[0].split("-").map(Number);
    if (ano !== anoSel || mes !== mesSel) return false;
    if (lojaSelecionada && p.Loja !== lojaSelecionada) return false;
    return true;
  });

  // Atualiza cards no DOM
document.getElementById("valor-a-enviar-dashboard").textContent    = totalAEnviar;
document.getElementById("valor-atrasados-dashboard").textContent   = atrasados;
document.getElementById("valor-risco-dashboard").textContent       = quaseAtrasando;
document.getElementById("valor-enviados-dashboard").textContent    = enviadosFiltradosNoMes.length;

const percentual = totalAEnviar > 0
  ? ((atrasados / totalAEnviar) * 100).toFixed(1) + "%"
  : "0%";

document.getElementById("percentual-atrasados").textContent = percentual;

}

AppCasaRosa.gerarResumoVendasPorProduto = function () {
  const enviados = AppCasaRosa.enviadosList || [];

  const dataSelecionada = document.getElementById("filtroDataDashboard")?.value;
  const considerarMesInteiro = document.getElementById("filtroMesInteiroDashboard")?.checked;
  const lojaSelecionada = document.getElementById("filtroLojaDashboard")?.value;
  const produtosSelecionados = $('#filtroProdutoDashboard').val() || [];

  const resumo = {};

  enviados.forEach(p => {
    if (!p.dataEnvio) return;

    const dataEnvioStr = p.dataEnvio.split("T")[0];
    const [ano, mes, dia] = dataEnvioStr.split("-").map(Number);

    if (dataSelecionada) {
      const [anoSel, mesSel, diaSel] = dataSelecionada.split("-").map(Number);

      if (!considerarMesInteiro && dataEnvioStr !== dataSelecionada) return;
      if (considerarMesInteiro && (ano !== anoSel || mes !== mesSel)) return;
    }

    if (lojaSelecionada && p.Loja !== lojaSelecionada) return;

    // Usa os SKUs equivalentes em mem√≥ria
    const agrupamentos = AppCasaRosa.skusEquivalentes || {};
    const skuOriginal = p.SKU || "Produto desconhecido";

    // Aplica agrupamento: transforma para SKU base se existir
    const sku = Object.entries(agrupamentos).find(([, lista]) => lista.includes(skuOriginal))?.[0] || skuOriginal;

    // Aplica filtro, se houver
    if (produtosSelecionados.length > 0 && !produtosSelecionados.includes(sku)) return;

    resumo[sku] = (resumo[sku] || 0) + 1;
  });

  const container = document.getElementById("vendas-por-produto");
  if (!container) {
    console.warn("‚ö†Ô∏è Elemento #vendas-por-produto n√£o encontrado.");
    return;
  }

  container.innerHTML = "";

  if (!Object.keys(resumo).length) {
    container.innerHTML = "<div style='color:#6c757d;'>Nenhuma venda registrada.</div>";
    return;
  }

  Object.entries(resumo)
    .sort((a, b) => b[1] - a[1])
    .forEach(([produto, qtd]) => {
      const card = document.createElement("div");
      Object.assign(card.style, {
        background: "#ffffff",
        border: "1px solid #dee2e6",
        borderRadius: "0.5rem",
        padding: "1rem",
        boxShadow: "0 2px 4px rgba(0,0,0,0.05)",
        textAlign: "center",
        flex: "1 1 200px"
      });
      card.innerHTML = `
        <div style="font-weight:bold;font-size:1.1rem;color:#212529;">${produto}</div>
        <div style="font-size:1.25rem;color:#dc3545;margin-top:0.5rem;">${qtd}</div>
        <div style="font-size:0.8rem;color:#6c757d;">vendidos</div>
      `;
      container.appendChild(card);
    });
};

// 1) Dias √∫teis entre duas datas (exclui in√≠cio ou fim conforme necessidade)
function calcularDiasUteis(dataInicial, dataFinal) {
  let d1 = new Date(dataInicial);
  let d2 = new Date(dataFinal);
  d1.setHours(0, 0, 0, 0);
  d2.setHours(0, 0, 0, 0);
  if (d1 > d2) return 0;
  let count = 0;
  while (d1 <= d2) {
    const dia = d1.getDay();
    if (dia !== 0 && dia !== 6) count++;
    d1.setDate(d1.getDate() + 1);
  }
  return Math.max(0, count - 1);
}
function atualizarResumoPedidosAEviar() {
  const pendentes = AppCasaRosa.importadosList || [];
  const enviados  = AppCasaRosa.enviadosList   || [];

  const hoje = new Date();
  hoje.setHours(0, 0, 0, 0);
  const hojeStr = hoje.toISOString().split("T")[0];

  let total = 0;
  let atrasados = 0;
  let risco = 0;
  let enviadosHoje = 0;

  const enviadosHojeSet = new Set(
    enviados
      .filter(p => (p.dataEnvio || "").split("T")[0] === hojeStr)
      .map(p => (p.pedidoId || p.Pedido || "").toString().trim())
  );

const enviadosSet = new Set(
    enviados.map(p => (p.id || p.pedidoId || p.Pedido || "").toString().trim())
  );

  pendentes.forEach(p => {
    const id = (p.id || p.pedidoId || p.Pedido || "").toString().trim();
    if (enviadosSet.has(id)) return;

    const dataPag = p.dataPagamento ? new Date(p.dataPagamento) : null;
    if (!dataPag) return;

    const diasUteis = calcularDiasUteis(dataPag, hoje);
    total++;
    if (diasUteis >= 2) atrasados++;
    else if (diasUteis === 1) risco++;
  });

  enviadosHoje = enviadosHojeSet.size;

// Atualiza os cards no DOM
  document.getElementById("resumo-total-enviar").textContent = total;
  document.getElementById("resumo-atrasados").textContent = atrasados;
  document.getElementById("resumo-risco").textContent = risco;
  document.getElementById("resumo-enviados-hoje").textContent = enviadosHoje;
}

function exportarPedidosAEnviar() {
  const pendentes = AppCasaRosa.importadosList || [];
  const enviados  = AppCasaRosa.enviadosList   || [];
  const enviadosSet = new Set(enviados.map(p => (p.id || p.pedidoId || "").toString().trim()));

  const pedidosAEnviar = pendentes.filter(p => {
    const id = (p.id || p.pedidoId || "").toString().trim();
    return !enviadosSet.has(id);
  });

  if (pedidosAEnviar.length === 0) {
    alert("Nenhum pedido a enviar encontrado.");
    return;
  }

  // Seleciona os campos principais para exportar
  const dados = pedidosAEnviar.map(p => ({
    Pedido: p.pedidoId || p.Pedido || "",
    Loja: p.Loja || "",
    SKU: p.SKU || "",
    DataPagamento: p.dataPagamento || "",
    Rastreio: p.rastreio || p.Rastreio || p.codigoRastreio || "",
  }));

  const ws = XLSX.utils.json_to_sheet(dados);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Pedidos A Enviar");
  XLSX.writeFile(wb, "pedidos_a_enviar.xlsx");
}
// 2) Exporta os pedidos cancelados para CSV usando os campos do Firestore
function exportarCanceladosCSV() {
  const dados = AppCasaRosa.canceladosList || [];
  if (!dados.length) {
    alert("Nenhum pedido cancelado para exportar.");
    return;
  }

  // Cabe√ßalho CSV
  const linhas = [
    ["Pedido", "Loja", "Produto", "Data Pagamento", "Rastreio", "Motivo"]
  ];

  // Monta cada linha a partir das propriedades corretas
  dados.forEach(p => {
    linhas.push([
      p.pedidoId || "",                              // ID do pedido
      p.Loja     || "",                              // Nome da loja
      p.SKU      || "",                              // SKU do produto
      p.dataPagamento ? p.dataPagamento.split("T")[0] : "", // Data pagamento
      p.Rastreio || "",                              // C√≥digo de rastreio
      p.motivo   || "-"                              // Motivo do cancelamento
    ]);
  });

  // Gera CSV e dispara download
  const csv = linhas.map(row => row.map(c => `"${c}"`).join(",")).join("\n");
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "pedidos_cancelados.csv";
  link.click();
}
// Substitua sua vers√£o antiga por esta:


  // Preenche o <select> de lojas no Dashboard usando dados em mem√≥ria
 // Fun√ß√£o no namespace AppCasaRosa
AppCasaRosa.preencherFiltroLojaDashboard = function() {
  const enviados  = AppCasaRosa.enviadosList   || [];
  const pendentes = AppCasaRosa.importadosList || [];
  const lojas = [...enviados, ...pendentes]
    .map(p => (p.Loja || "").trim().toLowerCase())
    .filter(Boolean);
  const lojasUnicas = [...new Set(lojas)].sort();
  const select = document.getElementById("filtroLojaDashboard");
  if (!select) return;
  // Fun√ß√£o para capitalizar cada palavra
  function capitalizeWords(str) {
    return str.replace(/\b\w/g, l => l.toUpperCase());
  }
  select.innerHTML =
    '<option value="">Todas</option>' +
    lojasUnicas.map(loja =>
      `<option value="${loja}">${capitalizeWords(loja)}</option>`
    ).join('');
};

// Dispara ao carregar a p√°gina
document.addEventListener("DOMContentLoaded", () => {
  if (typeof AppCasaRosa.atualizarResumoVendasMensal === "function") AppCasaRosa.atualizarResumoVendasMensal();
  if (typeof AppCasaRosa.atualizarDashboardPorDataLoja === "function") AppCasaRosa.atualizarDashboardPorDataLoja();
  if (typeof AppCasaRosa.preencherFiltroLojaDashboard === "function") AppCasaRosa.preencherFiltroLojaDashboard();
   if (typeof AppCasaRosa.preencherFiltroLojaMetas === "function") AppCasaRosa.preencherFiltroLojaMetas();
  if (typeof AppCasaRosa.carregarProdutos === "function") AppCasaRosa.carregarProdutos();
  if (typeof AppCasaRosa.atualizarRelatorioMetas === "function") AppCasaRosa.atualizarRelatorioMetas();

  // Ajusta o filtro de data da aba ‚ÄúImportados‚Äù para hoje
  const hoje = new Date().toISOString().split("T")[0];
  const inputFiltroData = document.getElementById("filtroData");
  if (inputFiltroData) inputFiltroData.value = hoje;

  // Filtro Multiloja na aba "A Enviar"
  const tabEnviar = document.querySelector("div.tab[onclick=\"abrirAba('a_enviar')\"]");
  if (tabEnviar) {
    tabEnviar.addEventListener("click", () => {
      const pendentes = AppCasaRosa.importadosList || [];
      const lojas = [...new Set(pendentes.map(p => p.Loja).filter(Boolean))].sort();
      const select = document.getElementById("filtroMultiloja");
      if (select) {
        select.innerHTML = lojas.map(l => `<option value="${l}">${l}</option>`).join("");
      }
        if (typeof AppCasaRosa.atualizarDashboardPendentes === "function") {
        AppCasaRosa.atualizarDashboardPendentes();
      }
    });
  }

  // Listeners dos filtros do dashboard
  const filtroLojaDashboard = document.getElementById("filtroLojaDashboard");
  if (filtroLojaDashboard && typeof atualizarDashboardPorData === "function")
    filtroLojaDashboard.addEventListener("change", atualizarDashboardPorData);

  const filtroDataDashboard = document.getElementById("filtroDataDashboard");
  if (filtroDataDashboard && typeof atualizarDashboardPorData === "function")
    filtroDataDashboard.addEventListener("change", atualizarDashboardPorData);

  const filtroMesInteiroDashboard = document.getElementById("filtroMesInteiroDashboard");
  if (filtroMesInteiroDashboard && typeof AppCasaRosa.atualizarDashboardPorDataLoja === "function")
      filtroMesInteiroDashboard.addEventListener("change", AppCasaRosa.atualizarDashboardPorDataLoja);

  // Listeners para atualiza√ß√£o do dashboard por loja
    if (filtroDataDashboard && typeof AppCasaRosa.atualizarDashboardPorDataLoja === "function")
      filtroDataDashboard.addEventListener("change", AppCasaRosa.atualizarDashboardPorDataLoja);

  if (filtroMesInteiroDashboard && typeof atualizarDashboardPorDataLoja === "function")
    filtroMesInteiroDashboard.addEventListener("change", atualizarDashboardPorDataLoja);

  const mesDash = document.getElementById("filtroMesDashboard");
  if (mesDash && typeof AppCasaRosa.atualizarDashboardPorDataLoja === "function")
      mesDash.addEventListener("change", AppCasaRosa.atualizarDashboardPorDataLoja);
});
AppCasaRosa.preencherFiltroProdutosDashboard = function() {
  const enviados = AppCasaRosa.enviadosList || [];
  const produtos = new Set();

  enviados.forEach(p => {
    if (p.SKU) produtos.add(p.SKU);
  });

  const select = document.getElementById("filtroProdutoDashboard");
  if (!select) return; // Seguran√ßa: n√£o faz nada se o elemento n√£o existe

  // Option padr√£o "Todas"
  select.innerHTML = '<option value="">Todas</option>';

  Array.from(produtos)
    .sort()
    .forEach(sku => {
      const option = document.createElement("option");
      option.value = sku;
      option.textContent = sku;
      select.appendChild(option);
    });

  // Atualizar Select2, se estiver usando
  if (window.$ && $(select).hasClass("select2-hidden-accessible")) {
    $(select).trigger('change.select2');
  }
};
  // Exporta relat√≥rio mensal de ‚ÄúPedidos Enviados‚Äù para CSV
  function exportarRelatorioMensal() {
    const enviados = AppCasaRosa.enviadosList || [];
    const mesSelecionado = document.getElementById("filtroMesRelatorio")?.value;
    if (!mesSelecionado) {
      alert("Selecione um m√™s para gerar o relat√≥rio.");
      return;
    }

    const [ano, mes] = mesSelecionado.split("-").map(Number);
    const resumo = {};

    enviados.forEach(p => {
      if (!p.dataEnvio) return;
      const [y, m] = p.dataEnvio.split("T")[0].split("-").map(Number);
      if (y !== ano || m !== mes) return;
      const chave = `${p.SKU || "Produto desconhecido"} | ${p.Loja || "Loja desconhecida"}`;
      resumo[chave] = (resumo[chave] || 0) + 1;
    });

    const linhas = [["Produto | Loja", "Quantidade Vendida"]];
    Object.entries(resumo).forEach(([chave, qtd]) => linhas.push([chave, qtd]));

    if (linhas.length === 1) {
      alert("Nenhum produto vendido nesse m√™s.");
      return;
    }

    const csv = linhas.map(row => row.map(c => `"${c}"`).join(",")).join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `relatorio_vendas_${mesSelecionado}.csv`;
    link.click();
  }

async function exportarRelatorioPDF() {
  const { jsPDF } = AppCasaRosa.jspdf;
  const doc = new jsPDF();

  // 1) Pega os dados em mem√≥ria e o m√™s selecionado
  const enviados = AppCasaRosa.enviadosList || [];
  const mesSelecionado = document.getElementById("filtroMesRelatorio")?.value;
  if (!mesSelecionado) {
    alert("Selecione um m√™s para gerar o relat√≥rio.");
    return;
  }

  const [anoSel, mesSel] = mesSelecionado.split("-").map(Number);
  const resumo = {};

  // 2) Agrupa por ‚ÄúProduto | Loja‚Äù apenas no m√™s/ano escolhidos
  enviados.forEach(p => {
    if (!p.dataEnvio) return;
    const [y, m] = p.dataEnvio.split("T")[0].split("-").map(Number);
    if (y !== anoSel || m !== mesSel) return;
    const produto = p.SKU || "Produto desconhecido";
    const loja    = p.Loja || "Loja desconhecida";
    const chave   = `${produto} | ${loja}`;
    resumo[chave] = (resumo[chave] || 0) + 1;
  });

  if (Object.keys(resumo).length === 0) {
    alert("Nenhum produto vendido nesse m√™s.");
    return;
  }

  // 3) Cabe√ßalho e logo (opcional)
  const nomeLoja     = "Casa Rosa Bela";
  const mesFormatado = `${String(mesSel).padStart(2, "0")}/${anoSel}`;
  const logoUrl      = "https://i.imgur.com/y3c6tLx.png";
  const img = new Image();
  img.crossOrigin = "anonymous";
  img.src = logoUrl;
  await new Promise(resolve => {
    img.onload = () => {
      doc.addImage(img, "PNG", 10, 10, 30, 30);
      resolve();
    };
  });

  doc.setFontSize(16);
  doc.text("Relat√≥rio de Produtos Vendidos", 50, 20);
  doc.setFontSize(12);
  doc.text(`Loja: ${nomeLoja}`, 50, 28);
  doc.text(`Per√≠odo: ${mesFormatado}`, 50, 35);

  // 4) Monta a tabela no PDF
  let y = 50;
  doc.setFontSize(11);
  doc.text("Produto | Loja", 14, y);
  doc.text("Qtd", 180, y, { align: "right" });
  y += 6;

  Object.entries(resumo).forEach(([linha, qtd]) => {
    doc.text(linha, 14, y);
    doc.text(String(qtd), 180, y, { align: "right" });
    y += 6;
    if (y > 280) {
      doc.addPage();
      y = 20;
    }
  });

  // 5) Gera o download
  doc.save(`relatorio_vendas_${mesSelecionado}.pdf`);
}


// Atualiza os cards de cancelamentos (hoje e no m√™s)
function atualizarResumoCancelados() {
  const cancelados = AppCasaRosa.canceladosList || [];

  const hoje = new Date();
  hoje.setHours(0, 0, 0, 0);
  const hojeStr  = hoje.toISOString().split("T")[0];
  const mesAtual = hoje.getMonth();
  const anoAtual = hoje.getFullYear();

  let totalHoje = 0;
  let totalMes  = 0;

  cancelados.forEach(p => {
    const dtStr = p.dataCancelamento?.split("T")[0];
    if (!dtStr) return;
    if (dtStr === hojeStr) totalHoje++;
    const dt = new Date(dtStr);
    if (dt.getFullYear() === anoAtual && dt.getMonth() === mesAtual) {
      totalMes++;
    }
  });

  document.getElementById("cancelados-hoje").textContent = totalHoje;
  document.getElementById("cancelados-mes").textContent  = totalMes;
}

// Gera o gr√°fico de cancelamentos por dia do m√™s atual
function gerarGraficoCancelados() {
  const cancelados = AppCasaRosa.canceladosList || [];
  const hoje = new Date();
  const ano  = hoje.getFullYear();
  const mes  = hoje.getMonth();

  // Inicializa contador para cada dia do m√™s
  const diasDoMes = {};
  for (let d = 1; d <= 31; d++) {
    const data = new Date(ano, mes, d);
    if (data.getMonth() !== mes) break;
    const diaStr = data.toISOString().split("T")[0];
    diasDoMes[diaStr] = 0;
  }

  // Conta cancelamentos por dataCancelamento
  cancelados.forEach(p => {
    const dtStr = p.dataCancelamento?.split("T")[0];
    if (dtStr in diasDoMes) diasDoMes[dtStr]++;
  });

  const labels  = Object.keys(diasDoMes).map(d => d.split("-")[2]);
  const valores = Object.values(diasDoMes);

  const ctx = document.getElementById("graficoCanceladosDia").getContext("2d");
  if (AppCasaRosa.graficoCancelados) AppCasaRosa.graficoCancelados.destroy();
  AppCasaRosa.graficoCancelados = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [{ label: "Cancelamentos", data: valores }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        x: { title: { display: true, text: "Dia do M√™s" } },
        y: { beginAtZero: true, title: { display: true, text: "Qtd Cancelamentos" } }
      }
    }
  });
}

function atualizarResumoCancelados() {
  // 1) Use o array em mem√≥ria preenchido pelo onSnapshot
  const cancelados = AppCasaRosa.canceladosList || [];

  // 2) Prepara datas para compara√ß√£o
  const hoje = new Date();
  hoje.setHours(0, 0, 0, 0);
  const hojeStr = hoje.toISOString().split("T")[0];
  const mesAtual = hoje.getMonth();
  const anoAtual = hoje.getFullYear();

  let totalHoje = 0;
  let totalMes  = 0;

  // 3) Conta cancelamentos de hoje e do m√™s
  cancelados.forEach(p => {
    // use o campo dataCancelamento gravado no Firestore
    const dtStr = p.dataCancelamento?.split("T")[0];
    if (!dtStr) return;

    if (dtStr === hojeStr) {
      totalHoje++;
    }
    const dt = new Date(dtStr);
    if (dt.getFullYear() === anoAtual && dt.getMonth() === mesAtual) {
      totalMes++;
    }
  });

  // 4) Atualiza o DOM
  document.getElementById("cancelados-hoje").textContent = totalHoje;
  document.getElementById("cancelados-mes").textContent  = totalMes;
}
  
</script>
<script>
  window.AppCasaRosa = window.AppCasaRosa || {};

function atualizarFiltroLoja() {
  // 1) Re√∫na todos os pedidos em mem√≥ria (importados + enviados , se houver)
  const importados = AppCasaRosa.importadosList || [];
  const enviados   = AppCasaRosa.enviadosList   || [];
  const historico  = AppCasaRosa.historicoList  || [];  // defina historicoList via onSnapshot, se usar
  const todas = [...importados, ...enviados, ...historico];

  // 2) Extrai e ordena as lojas √∫nicas
  const lojas = [...new Set(
    todas.map(p =>
      p.Loja ||
      p["Nome da Loja no UpSeller"] ||
      p["Nome da Loja"] ||
      ""
    ).filter(Boolean)
  )].sort();

  // 3) Extrai e ordena os SKUs √∫nicos
  const produtos = [...new Set(
    todas.map(p => p.SKU || "").filter(Boolean)
  )].sort();

  // 4) Atualiza os <select> de loja e produto
  const selectLoja    = document.getElementById("filtroLoja");
  const selectProduto = document.getElementById("filtroMultiproduto");

  if (selectLoja) {
    selectLoja.innerHTML =
      '<option value="">Todas</option>' +
      lojas.map(l => `<option value="${l}">${l}</option>`).join('');
  }
  if (selectProduto) {
    selectProduto.innerHTML =
      '<option value="">Todos</option>' +
      produtos.map(p => `<option value="${p}">${p}</option>`).join('');
  }
}
</script>
<script>
  window.AppCasaRosa = window.AppCasaRosa || {};
function gerarGraficoStatus(pendentes, enviados) {
  const hoje = new Date();
  hoje.setHours(0, 0, 0, 0);

  let risco = 0;
  let atrasados = 0;
  let enviadosHoje = 0;

  // Processa pendentes
 pendentes.forEach(p => {
    const pagamento = normalizarCampo(p, ["Pagamento", "Impress√£o da Etiqueta"]).split(" ")[0];
    if (!pagamento) return;
    const dataPag = new Date(pagamento.split("T")[0] || pagamento);
    const uteis = calcularDiasUteis(dataPag, hoje);
    if (uteis === 1) risco++;
    else if (uteis >= 2) atrasados++;
  });

  // Processa enviados hoje
  enviados.forEach(p => {
    const envio = normalizarCampo(p, ["Hora de Envio"]);
    if (!envio) return;
    const dataEnvio = new Date(envio.split("T")[0] || envio.split(" ")[0]);
    dataEnvio.setHours(0, 0, 0, 0);
    if (dataEnvio.getTime() === hoje.getTime()) {
      enviadosHoje++;
    }
  });

  const ctx = document.getElementById('graficoStatus').getContext('2d');
  if (AppCasaRosa.statusChart) AppCasaRosa.statusChart.destroy();

  AppCasaRosa.statusChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: [
        `‚ö†Ô∏è Em Risco (${risco})`,
        `‚è∞ Atrasados (${atrasados})`,
        `‚úÖ Enviados Hoje (${enviadosHoje})`
      ],
      datasets: [{
        data: [risco, atrasados, enviadosHoje],
        backgroundColor: ['#ffc107', '#dc3545', '#198754'],
        borderColor: ['#ffc107', '#dc3545', '#198754'],
        borderWidth: 1
      }]
    },
    options: {
      plugins: {
        legend: {
          position: 'bottom'
        }
      }
    }
  });
}
</script>
<script>
  window.AppCasaRosa = window.AppCasaRosa || {};
  // 1) Fun√ß√£o de dias √∫teis permanece igual
function diasUteisEntre(dataInicial, dataFinal) {
  let count = 0;
  let currentDate = new Date(dataInicial);
  while (currentDate <= dataFinal) {
    const diaSemana = currentDate.getDay();
    if (diaSemana !== 0 && diaSemana !== 6) count++;
    currentDate.setDate(currentDate.getDate() + 1);
  }
  return count - 1;
}
</script>
<script>
  window.AppCasaRosa = window.AppCasaRosa || {};
// 2) Nova fun√ß√£o gerarLembrete usando os arrays em mem√≥ria
// 3) Atualiza a chamada para incluir gerarLembrete (e usar os estados em mem√≥ria)
const originalAtualizar = atualizarTabelas;
atualizarTabelas = function() {
  originalAtualizar();
  preencherFiltroLojaDashboard();
  gerarGraficoStatus(AppCasaRosa.importadosList, AppCasaRosa.enviadosList);
  
};


const originalRenderTabela = renderTabela;
renderTabela = function(destinoId, dados) {
  if (destinoId === "tabelaPendentes") {
    const lojaSelecionada = document.getElementById("filtroLoja")?.value || "";
    const produtoSelecionado = document.getElementById("filtroProduto")?.value || "";

    const filtrado = dados.filter(p => {
      const loja = p["Nome da Loja no UpSeLLer"] || p["Nome da Loja no UpSeller"] || p["Loja"] || p["Nome da Loja"] || p[Object.keys(p)[1]] || "";
      const produto = p["SKU"] || "";

      const lojaOk = lojaSelecionada === "" || loja === lojaSelecionada;
      const produtoOk = produtoSelecionado === "" || produto === produtoSelecionado;

      return lojaOk && produtoOk;
    });

    originalRenderTabela(destinoId, filtrado);
  } else {
    originalRenderTabela(destinoId, dados);
  }
};
</script>
  <script>
    window.AppCasaRosa = window.AppCasaRosa || {};
  function considerar(loja) {
 const lojasSelecionadas = Array.from(selectLoja.selectedOptions).map(opt => opt.value);
const lojaOk = !lojasSelecionadas.length || lojasSelecionadas.includes(loja);
  }
    </script>
<script>
  window.AppCasaRosa = window.AppCasaRosa || {};

function atualizarDashboardPorData() {
  // 1) Obtenha os pedidos enviados do estado em mem√≥ria (atualizado pelo onSnapshot)
  const enviados = AppCasaRosa.enviadosList || [];

  // 2) Data de hoje zerada para compara√ß√£o
  const hoje = new Date();
  hoje.setHours(0, 0, 0, 0);

  // 3) Formate a data de hoje para exibi√ß√£o
  const hojeFormatado = new Intl.DateTimeFormat("pt-BR", {
    day: "2-digit", month: "2-digit", year: "numeric"
  }).format(hoje);
   const elDataHoje = document.getElementById("data-hoje-formatada");
    if (elDataHoje) elDataHoje.textContent = hojeFormatado;

  // 4) Filtra os pedidos enviados na data selecionada
const dataSelecionada = document.getElementById("filtroDataDashboard")?.value;

const enviadosNoDia = enviados.filter(p => {
  if (!p.dataEnvio || !dataSelecionada) return false;

  const [dataStr] = p.dataEnvio.split("T"); // "2025-05-21"
  return dataStr === dataSelecionada; // compara com valor do input "yyyy-mm-dd"
});

// 5) Atualiza o card üì¶
  const enviadosHoje = enviadosNoDia.length;
  const elEnvHoy = document.getElementById("enviadosHoje");
  if (elEnvHoy) elEnvHoy.textContent = enviadosHoje;



 // 6) Atualiza o elemento com o total de hoje
  const elTotalHoje = document.getElementById("total-hoje");
  if (elTotalHoje) elTotalHoje.textContent = enviadosHoje;
}
</script>
<script>
  window.AppCasaRosa = window.AppCasaRosa || {};
function atualizarDashboardHoje() {
  let totalHoje = 0;
  let atrasados = 0;
  let emRisco = 0;
  let enviadosHoje = 0;

  const hoje = new Date();
  const hojeStr = hoje.toISOString().split("T")[0];

 (AppCasaRosa.importadosList || []).forEach(p => {
    if (p.status !== "novo") return;

    const loja = p.Loja || "";
    const dataPag = (p.dataPagamento || "").split("T")[0];
    if (!dataPag || !considerar(loja)) return;

    const dataPagObj = new Date(dataPag);
    const diasUteis = calcularDiasUteis(dataPagObj, hoje);

    if (dataPag === hojeStr) totalHoje++;
    if (diasUteis >= 3) atrasados++;
    else if (diasUteis === 2) emRisco++;
  });

  enviados.forEach(e => {
    const loja = e.Loja || "";
    const dataEnvio = (e.dataEnvio || "").split("T")[0];
    if (dataEnvio === hojeStr && considerar(loja)) enviadosHoje++;
  });

  const elTotal = document.getElementById("totalEnviarHoje");
  if (elTotal) elTotal.textContent = totalHoje;

  const elAtrasados = document.getElementById("atrasadosHoje");
  if (elAtrasados) elAtrasados.textContent = atrasados;

  const elRisco = document.getElementById("emRiscoHoje");
  if (elRisco) elRisco.textContent = emRisco;

  const elEnviados = document.getElementById("enviadosHoje");
  if (elEnviados) elEnviados.textContent = enviadosHoje;
}

</script>
<script>
  window.AppCasaRosa = window.AppCasaRosa || {};
async function processarPDF() {
  const input = document.getElementById('inputPDF');
  if (!input.files.length) {
    alert("Selecione um arquivo PDF.");
    return;
  }

  const file = input.files[0];
  const reader = new FileReader();

  reader.onload = async function (e) {
    const typedArray = new Uint8Array(e.target.result);
    const pdf = await pdfjsLib.getDocument({ data: typedArray }).promise;

    let fullText = "";
    for (let i = 0; i < pdf.numPages; i++) {
      const page = await pdf.getPage(i + 1);
      const content = await page.getTextContent();
      fullText += content.items.map(item => item.str).join("\n") + "\n";
    }

    console.log("üîç TEXTO LIDO:", fullText);
    const pedidosExtraidos = [];

  const multiRegex = /\*\d+\s*NF[: ]/i;
  if (multiRegex.test(fullText)) {
    const blocos = fullText
      .split(/\*\d+\s*NF[: ]/i)
      .filter(b => /Pedido/i.test(b));
    blocos.forEach(bloco => {
     // Ancorado na palavra-chave "Pedido" para evitar falsos positivos
      const pedidoMatch = bloco.match(/Pedido[:\s]*([A-Z0-9]{10,})/i);
      const pedido = pedidoMatch ? pedidoMatch[1] : "";

   const rastreio = bloco.match(/(BR\d{12,}[A-Z]?)/)?.[1] || "";
      const loja = identificarLoja(bloco);
      const pagamentoMatch = bloco.match(/(\d{2}\/\d{2}\/\d{4})/);
      const pagamento = pagamentoMatch
        ? `${pagamentoMatch[1].split("/").reverse().join("-")}T00:00:00.000Z`
        : "";
       // SKU informado ap√≥s o texto "SKU:" ou semelhante
      const skuMatch = bloco.match(/SKU[:\s]*#?([A-Z0-9\-+]+)/i);
      const sku = skuMatch ? skuMatch[1].trim() : "";

    if (pedido && sku && pagamento) {
      pedidosExtraidos.push({
        Pedido: pedido,
        Loja: loja,
        SKU: sku,
        Rastreio: rastreio,
        dataPagamento: pagamento,
        status: "pendente"
      });
    }
  });

  } else {
   // Procura a informa√ß√£o de pedido precedida da palavra "Pedido"
    const pedidoMatch = fullText.match(/Pedido[:\s]*([A-Z0-9]{10,})/i);
    const pedido = pedidoMatch ? pedidoMatch[1] : "";
  const rastreio = fullText.match(/(BR\d{12,}[A-Z]?)/)?.[1] || "";

  const pagamentoMatch = fullText.match(/(\d{2}\/\d{2}\/\d{4})/);
  const pagamento = pagamentoMatch
    ? `${pagamentoMatch[1].split("/").reverse().join("-")}T00:00:00.000Z`
    : "";

  const skuMatch = fullText.match(/SKU[:\s]*#?([A-Z0-9\-+]+)/i);
  const sku = skuMatch ? skuMatch[1].trim() : "";

  const loja = identificarLoja(fullText);

  if (pedido && sku && pagamento) {
    pedidosExtraidos.push({
      Pedido: pedido,
      Loja: loja,
      SKU: sku,
      Rastreio: rastreio,
      dataPagamento: pagamento,
      status: "pendente"
    });
  }
}


if (!pedidosExtraidos.length) {
  alert("‚ùå Nenhum pedido v√°lido foi encontrado no PDF.");
  return;
}



    // üíæ Verifica se j√° existem pedidos iguais no Firestore
    const existentesSnap = await AppCasaRosa.getDocs(AppCasaRosa.collection(AppCasaRosa.db, "pedidos_pendentes"));
    const pedidosExistentes = new Set(existentesSnap.docs.map(d => (d.data().Pedido || "").trim()));

    // üì¶ Filtra apenas os pedidos novos
    const novosFiltrados = pedidosExtraidos.filter(p => !pedidosExistentes.has((p.Pedido || "").trim()));

    if (!novosFiltrados.length) {
      alert("‚ö†Ô∏è Todos os pedidos deste PDF j√° foram importados.");
      return;
    }

    // üíæ Salva apenas os pedidos novos
    await Promise.all(novosFiltrados.map(p => adicionarPedido(p)));

    await addDoc(collection(db, "pdf_etiquetas"), {
      nome: file.name,
      dataImportacao: new Date().toISOString()
    });

    alert(`‚úÖ ${novosFiltrados.length} etiqueta(s) importada(s) com sucesso.`);
  };

  reader.readAsArrayBuffer(file);
}
AppCasaRosa.processarPDF = processarPDF;




function abrirPDF(index) {
  const pdfs = AppCasaRosa.pdfsList || [];
  const pdf = pdfs[index];
  if (!pdf) return;
  const blob = dataURLToBlob(pdf.conteudo);
  const url = URL.createObjectURL(blob);
  AppCasaRosa.open(url, "_blank");
}

function baixarPDF(index) {
  // Use o array em mem√≥ria carregado pelo onSnapshot
  const pdfs = AppCasaRosa.pdfsList || [];
  const item = pdfs[index];
  if (!item) return;

  // item.conteudo √© a string base64 do PDF
  const link = document.createElement("a");
  link.href = "data:application/pdf;base64," + item.conteudo;
  link.download = item.nome;
  link.click();
}
</script>
<script>
  window.AppCasaRosa = window.AppCasaRosa || {};
// Converte um Blob (ou ArrayBuffer) em string base64
function blobToBase64(blob) {
  return new Promise(resolve => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result.split(",")[1]);
    reader.readAsDataURL(blob);
  });
}

// Converte dataURL (base64) em Blob
function dataURLToBlob(dataURL) {
  const [header, base64] = dataURL.split(",");
  const mime = header.match(/:(.*?);/)[1];
  const bytes = atob(base64);
  const buf = new Uint8Array(bytes.length);
  for (let i = 0; i < bytes.length; i++) buf[i] = bytes.charCodeAt(i);
  return new Blob([buf], { type: mime });
}

function exportarVendasCSV() {
  const enviados = AppCasaRosa.enviadosList || [];
  const dataSelecionada = document.getElementById("filtroDataDashboard")?.value;
  const considerarMesInteiro = document.getElementById("filtroMesInteiroDashboard")?.checked;
  const lojaSelecionada = document.getElementById("filtroLojaDashboard")?.value;

  if (!dataSelecionada) {
    alert("Selecione uma data para exportar.");
    return;
  }

  const [anoSel, mesSel, diaSel] = dataSelecionada.split("-").map(Number);

  const resumo = {};

  enviados.forEach(p => {
    const dt = new Date(p.dataEnvio);
    if (isNaN(dt)) return;

    const ano = dt.getFullYear();
    const mes = dt.getMonth() + 1;
    const dia = dt.getDate();

    if (
      (!considerarMesInteiro && dt.toISOString().split("T")[0] !== dataSelecionada) ||
      (considerarMesInteiro && (ano !== anoSel || mes !== mesSel))
    ) {
      return;
    }

    const loja = p.Loja || "Loja desconhecida";
    if (lojaSelecionada && loja !== lojaSelecionada) return;

const skuBase = AppCasaRosa.obterSkuBase(p.SKU);
resumo[skuBase] = (resumo[skuBase] || 0) + 1;

  });

  const linhas = [["Produto", "Quantidade"]];
  Object.entries(resumo).forEach(([produto, qtd]) => {
    linhas.push([produto, qtd]);
  });

  const csv = linhas.map(l => l.join(";")).join("\n");
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "vendas_filtradas.csv";
  link.click();
}
async function exportarVendasPDF() {
  const { jsPDF } = AppCasaRosa.jspdf;
  const doc = new jsPDF();

  const enviados = AppCasaRosa.enviadosList || [];
  const dataSelecionada = document.getElementById("filtroDataDashboard")?.value;
  const considerarMesInteiro = document.getElementById("filtroMesInteiroDashboard")?.checked;
  const lojaSelecionada = document.getElementById("filtroLojaDashboard")?.value;

  if (!dataSelecionada) {
    alert("Selecione uma data para gerar o relat√≥rio.");
    return;
  }

  const [anoSel, mesSel, diaSel] = dataSelecionada.split("-").map(Number);

  const resumo = {};
  enviados.forEach(p => {
    const dt = new Date(p.dataEnvio);
    if (isNaN(dt)) return;

    const ano = dt.getFullYear();
    const mes = dt.getMonth() + 1;
    const dia = dt.getDate();

    if (
      (!considerarMesInteiro && dt.toISOString().split("T")[0] !== dataSelecionada) ||
      (considerarMesInteiro && (ano !== anoSel || mes !== mesSel))
    ) {
      return;
    }

    const loja = p.Loja || "Loja desconhecida";
    if (lojaSelecionada && loja !== lojaSelecionada) return;

    const skuBase = AppCasaRosa.obterSkuBase(p.SKU);
resumo[skuBase] = (resumo[skuBase] || 0) + 1;

  });

  // Cabe√ßalho do PDF
  doc.setFontSize(16);
  doc.text("Relat√≥rio de Pe√ßas Vendidas", 14, 20);
  doc.setFontSize(12);

  if (considerarMesInteiro) {
    doc.text(`Per√≠odo: ${String(mesSel).padStart(2, "0")}/${anoSel}`, 14, 28);
  } else {
    doc.text(`Data: ${diaSel}/${mesSel}/${anoSel}`, 14, 28);
  }

  if (lojaSelecionada) {
    doc.text(`Loja: ${lojaSelecionada}`, 14, 35);
  }

  // Tabela
  let y = 45;
  doc.setFontSize(11);
  doc.text("Produto", 14, y);
  doc.text("Qtd", 180, y, { align: "right" });
  y += 6;

  Object.entries(resumo).forEach(([produto, qtd]) => {
    doc.text(produto, 14, y);
    doc.text(`${qtd}`, 180, y, { align: "right" });
    y += 6;
    if (y > 280) {
      doc.addPage();
      y = 20;
    }
  });

  doc.save("vendas_filtradas.pdf");
}
function exportarDashboardExcel() {
  const aenviar = document.getElementById("valor-a-enviar-dashboard").textContent;
  const enviados = document.getElementById("valor-enviados-dashboard").textContent;
  const enviadosAtraso = document.getElementById("valor-enviados-atraso-dashboard")?.textContent || 0;
  const atrasados = document.getElementById("valor-atrasados-dashboard").textContent;
  const risco = document.getElementById("valor-risco-dashboard").textContent;

  const dados = [
    ["Indicador", "Quantidade"],
    ["üì¶ A Enviar", aEnviar],
    ["‚úÖ Enviados no m√™s", enviados],
    ["üö® Enviados com Atraso", enviadosAtraso],
    ["‚è∞ Atrasados", atrasados],
    ["‚ö†Ô∏è Em risco", risco]
  ];

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(dados);
  XLSX.utils.book_append_sheet(wb, ws, "Resumo Dashboard");
  XLSX.writeFile(wb, `resumo_dashboard.xlsx`);
}
async function exportarDashboardPDF() {
  const { jsPDF } = AppCasaRosa.jspdf;
  const doc = new jsPDF();

  const loja = document.getElementById("filtroLojaDashboard")?.value || "Todas";
  const mes = document.getElementById("filtroMesDashboard")?.value || "N√£o selecionado";

  const aEnviar = document.getElementById("valor-a-enviar-dashboard").textContent;
  const enviados = document.getElementById("valor-enviados-dashboard").textContent;
  const enviadosAtraso = document.getElementById("valor-enviados-atrasados-dashboard")?.textContent || "0";
  const atrasados = document.getElementById("valor-atrasados-dashboard").textContent;
  const risco = document.getElementById("valor-risco-dashboard").textContent;

  // Cabe√ßalho
  doc.setFontSize(16);
  doc.text("Relat√≥rio do Dashboard", 14, 20);
  doc.setFontSize(12);
  doc.text(`Loja: ${loja}`, 14, 28);
  doc.text(`M√™s: ${mes}`, 14, 34);

  // Tabela de resumo
  const col1 = 14;
  const col2 = 100;
  let y = 50;

  doc.setFontSize(12);
  doc.text("Indicador", col1, y);
  doc.text("Quantidade", col2, y);
  y += 8;

  const dados = [
    ["A Enviar", aEnviar],
    ["Enviados no m√™s", enviados],
    ["Enviados com Atraso", enviadosAtraso],
    ["Atrasados", atrasados],
    ["Em risco", risco]
  ];

  dados.forEach(([titulo, valor]) => {
    doc.text(titulo, col1, y);
    doc.text(String(valor), col2, y);
    y += 8;
  });

  doc.save("resumo_dashboard.pdf");
}
async function adicionarPedido(pedido) {
  try {
    await addDoc(collection(db, "pedidos_pendentes"), pedido);
  } catch (erro) {
    console.error("Erro ao adicionar pedido:", erro);
  }
}

 const abaEnviar = document.querySelector("div.tab[onclick=\"abrirAba('a_enviar')\"]");
if (abaEnviar) {
    abaEnviar.addEventListener("click", () => {
      AppCasaRosa.carregarPendentesFirebase();
    });
  }

async function apagarTudo() {
  if (!confirm("‚ö†Ô∏è Tem certeza que deseja apagar TODOS os dados do sistema? Isso n√£o pode ser desfeito.")) return;

  const colecoes = [
    "pedidos_pendentes",
    "pedidos_enviados",
    "pedidos_cancelados",
    "pdf_etiquetas",
    "historico_pedidos"
  ];

  for (const nome of colecoes) {
    const ref = collection(db, nome);
    const snap = await getDocs(ref);
    const promises = snap.docs.map(doc => deleteDoc(doc.ref));
    await Promise.all(promises);
    console.log(`Cole√ß√£o ${nome} apagada.`);
  }

  alert("‚úÖ Todos os dados foram apagados!");
  location.reload(); // Atualiza a p√°gina para limpar os dados carregados
}
// Encapsule a fun√ß√£o dentro do namespace
AppCasaRosa.atualizarDashboardPendentes = function() {
  const pendentes = AppCasaRosa.importadosList || [];
  const enviados  = AppCasaRosa.enviadosList   || [];
  const hoje = new Date();
  hoje.setHours(0, 0, 0, 0);

  const lojasSelecionadas = Array.from(
    document.getElementById("filtroMultiloja").selectedOptions
  ).map(opt => opt.value);

  const produtosSelecionados = Array.from(
    document.getElementById("filtroMultiproduto").selectedOptions
  ).map(opt => opt.value);

  const enviadosSet = new Set(enviados.map(p => p.pedidoId || p.Pedido));

  let total = 0, risco = 0, atraso = 0, enviadosHoje = 0;

  const pendentesFiltrados = pendentes.filter(p => {
    const idPedido = p.pedidoId || p.Pedido;
    if (enviadosSet.has(idPedido)) return false;

    const loja = p.Loja || "";
    const produto = p.SKU || "";

    const lojaOk = !lojasSelecionadas.length || lojasSelecionadas.includes(loja);
    const produtoOk = !produtosSelecionados.length || produtosSelecionados.includes(produto);
    if (!lojaOk || !produtoOk) return false;

    const dataPag = new Date(p.dataPagamento);
    if (isNaN(dataPag)) return false;

    // Encapsule tamb√©m calcularDiasUteis se for sua!
    const uteis = AppCasaRosa.calcularDiasUteis
      ? AppCasaRosa.calcularDiasUteis(dataPag, hoje)
      : calcularDiasUteis(dataPag, hoje); // fallback para global se necess√°rio

    total++;
    if (uteis >= 2) atraso++;
    else if (uteis === 1) risco++;

    return true;
  });

  // Enviados hoje (filtrados)
  enviados.forEach(p => {
    const loja = p.Loja || "";
    const produto = p.SKU || "";

    const lojaOk = !lojasSelecionadas.length || lojasSelecionadas.includes(loja);
    const produtoOk = !produtosSelecionados.length || produtosSelecionados.includes(produto);
    if (!lojaOk || !produtoOk) return;

    const dt = new Date(p.dataEnvio?.split("T")[0]);
    dt.setHours(0, 0, 0, 0);
    if (dt.getTime() === hoje.getTime()) enviadosHoje++;
  });

  // Atualiza os cards
  document.getElementById("resumo-total-enviar").textContent = total;
  document.getElementById("resumo-atrasados").textContent = atraso;
  document.getElementById("resumo-risco").textContent = risco;
  document.getElementById("resumo-enviados-hoje").textContent = enviadosHoje;

  // Atualiza a tabela
  if (AppCasaRosa.renderTabela) {
    AppCasaRosa.renderTabela("tabelaPendentes", pendentesFiltrados);
  } else {
    renderTabela("tabelaPendentes", pendentesFiltrados); // fallback se n√£o encapsulou renderTabela ainda
  }
};

// Tamb√©m encapsule o event listener (opcional, mas recomendado):
AppCasaRosa.inicializarFiltroMultiloja = function() {
  const pendentes = AppCasaRosa.importadosList || [];
  const lojas = [...new Set(pendentes.map(p => p.Loja).filter(Boolean))].sort();

  const select = document.getElementById("filtroMultiloja");
  select.innerHTML = lojas.map(l => `<option value="${l}">${l}</option>`).join("");

  AppCasaRosa.atualizarDashboardPendentes();
};

// Registre o evento usando o namespace
document.querySelector("div.tab[onclick=\"abrirAba('a_enviar')\"]")
  .addEventListener("click", AppCasaRosa.inicializarFiltroMultiloja);

</script>
<!-- Select2 (estilo moderno para m√∫ltiplos selects) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
  window.AppCasaRosa = window.AppCasaRosa || {};
  $(document).ready(function() {
    $('#filtroMultiloja').select2({
      placeholder: 'Selecione lojas',
      width: '100%'
    });
    $('#filtroMultiproduto').select2({
      placeholder: 'Selecione produtos',
      width: '100%'
    });
  });
// üßπ Fun√ß√£o para verificar e remover pedidos duplicados (em qualquer aba)
async function verificarEDeduplicarPedidos() {
  const colecoes = [
    { nome: "pedidos_enviados", label: "enviados" },
    { nome: "pedidos_pendentes", label: "pendentes" },
    { nome: "pedidos_cancelados", label: "cancelados" },
  ];

  const vistosGlobais = new Set();
  const aExcluir = [];

  for (const { nome, label } of colecoes) {
    const snap = await AppCasaRosa.getDocs(
      AppCasaRosa.collection(AppCasaRosa.db, nome)
    );

    const vistosLocais = new Set();

    snap.forEach(doc => {
      const pedidoId = (doc.data().pedidoId || doc.data().Pedido || "").toString().trim().toUpperCase();
      if (!pedidoId) return;

      const keyGlobal = pedidoId;

      if (vistosLocais.has(pedidoId)) {
        aExcluir.push({ ref: doc.ref, motivo: `Duplicado interno em ${label}` });
      } else if (vistosGlobais.has(keyGlobal)) {
        aExcluir.push({ ref: doc.ref, motivo: `Duplicado entre cole√ß√µes (em ${label})` });
      } else {
        vistosLocais.add(pedidoId);
        vistosGlobais.add(keyGlobal);
      }
    });
  }

  if (aExcluir.length === 0) {
    alert("‚úÖ Nenhum pedido duplicado encontrado.");
    return;
  }

  for (const { ref } of aExcluir) {
    await AppCasaRosa.deleteDoc(ref);
  }

  alert(`‚úÖ ${aExcluir.length} pedidos duplicados foram removidos (internos e entre abas).`);
  location.reload();
}

// Torna acess√≠vel globalmente (caso esteja usando onclick no HTML)
window.verificarEDeduplicarPedidos = verificarEDeduplicarPedidos;
AppCasaRosa.verificarEDeduplicarPedidos = verificarEDeduplicarPedidos;
// üß† Inicializa√ß√£o segura do Select2 + evento change
$(document).ready(function () {
  $('#filtroProdutoDashboard').select2({
    placeholder: "Escolha os produtos",
    allowClear: true,
    width: 'resolve'
  });

  // Garante que a fun√ß√£o foi carregada antes de vincular
  if (typeof AppCasaRosa.gerarResumoVendasPorProduto === "function") {
    $('#filtroProdutoDashboard').on('change', AppCasaRosa.gerarResumoVendasPorProduto);
  }
});

// Refer√™ncia para gr√°fico global (opcional)
let graficoVendasPorDia;


AppCasaRosa.renderizarGraficoVendasPorDia = function() {
  const enviados = AppCasaRosa.enviadosList || [];
  const dataSelecionada = document.getElementById("filtroDataDashboard")?.value;
  const considerarMesInteiro = document.getElementById("filtroMesInteiroDashboard")?.checked;
  const lojaSelecionada = document.getElementById("filtroLojaDashboard")?.value;

  if (!dataSelecionada || !considerarMesInteiro) return;

  const [anoSel, mesSel] = dataSelecionada.split("-").map(Number);
  const diasDoMes = new Array(31).fill(0);

  enviados.forEach(p => {
    if (!p.dataEnvio) return;

    const dt = new Date(p.dataEnvio);
    if (isNaN(dt)) return;
    if (dt.getFullYear() !== anoSel || dt.getMonth() + 1 !== mesSel) return;

    if (lojaSelecionada && p.Loja !== lojaSelecionada) return;

    const dia = dt.getDate();
    diasDoMes[dia - 1] += 1;
  });

  const labels = diasDoMes.map((_, i) => `${String(i + 1).padStart(2, "0")}/${String(mesSel).padStart(2, "0")}`);
  const data = diasDoMes.slice(0, 31); // remove dias a mais

  const ctx = document.getElementById("graficoVendasPorDia").getContext("2d");

  if (AppCasaRosa.graficoVendasPorDia) AppCasaRosa.graficoVendasPorDia.destroy();

  AppCasaRosa.graficoVendasPorDia = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: "Pedidos Enviados",
        data,
        fill: false,
        borderColor: "#EF5DA8",
        tension: 0.2,
        pointRadius: 3
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: true,
          position: "top"
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { precision: 0 }
        }
      }
    }
  });
};

// Exemplo para o outro gr√°fico, caso queira encapsular tamb√©m:
AppCasaRosa.graficoTopProdutos = null;

AppCasaRosa.renderizarGraficoTopComparativo = function() {
  const enviados = AppCasaRosa.enviadosList || [];
  const tipo = document.getElementById("tipoComparativo")?.value || "produtos";
  const dataSelecionada = document.getElementById("filtroDataDashboard")?.value;
  const considerarMesInteiro = document.getElementById("filtroMesInteiroDashboard")?.checked;
  const lojaSelecionada = document.getElementById("filtroLojaDashboard")?.value;

  if (!dataSelecionada || !considerarMesInteiro) return;

  const [anoSel, mesSel] = dataSelecionada.split("-").map(Number);
  const contagem = {};

  enviados.forEach(p => {
    if (!p.dataEnvio) return;
    const dt = new Date(p.dataEnvio);
    if (isNaN(dt)) return;
    if (dt.getFullYear() !== anoSel || dt.getMonth() + 1 !== mesSel) return;

    if (lojaSelecionada && p.Loja !== lojaSelecionada) return;

    const chave = tipo === "lojas" ? (p.Loja || "Loja desconhecida") : (p.SKU || "Produto desconhecido");
    contagem[chave] = (contagem[chave] || 0) + 1;
  });

  const ordenado = Object.entries(contagem)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 10); // top 10

  const labels = ordenado.map(([nome]) => nome);
  const data = ordenado.map(([_, qtd]) => qtd);

  const ctx = document.getElementById("graficoTopProdutos").getContext("2d");

  if (AppCasaRosa.graficoTopProdutos) AppCasaRosa.graficoTopProdutos.destroy();

  AppCasaRosa.graficoTopProdutos = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label: tipo === "lojas" ? "Pedidos por Loja" : "Vendas por Produto",
        data,
        backgroundColor: "#D99074"
      }]
    },
    options: {
      indexAxis: "y",
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: context => `${context.parsed.x} pedidos`
          }
        }
      },
      scales: {
        x: {
          beginAtZero: true,
          ticks: { precision: 0 }
        }
      }
    }
  });
};

// Tamb√©m encapsule as vari√°veis de gr√°fico global, se necess√°rio:
AppCasaRosa.graficoTopProdutos = null;
AppCasaRosa.graficoTempoEnvio = null;

AppCasaRosa.renderizarGraficoTempoEnvio = function() {
  const enviados = AppCasaRosa.enviadosList || [];
  const dataSelecionada = document.getElementById("filtroDataDashboard")?.value;
  const considerarMesInteiro = document.getElementById("filtroMesInteiroDashboard")?.checked;
  const lojaSelecionada = document.getElementById("filtroLojaDashboard")?.value;

  if (!dataSelecionada || !considerarMesInteiro) return;

  const [anoSel, mesSel] = dataSelecionada.split("-").map(Number);
  const tempos = {};

  enviados.forEach(p => {
    if (!p.dataEnvio || !p.dataPagamento) return;

    const dataPag = new Date(p.dataPagamento);
    const dataEnvio = new Date(p.dataEnvio);
    if (isNaN(dataPag) || isNaN(dataEnvio)) return;

    if (dataEnvio.getFullYear() !== anoSel || dataEnvio.getMonth() + 1 !== mesSel) return;

    const loja = p.Loja || "Loja desconhecida";
    if (lojaSelecionada && loja !== lojaSelecionada) return;

    // Use encapsulado, se j√° estiver em AppCasaRosa
    const dias = AppCasaRosa.calcularDiasUteis 
      ? AppCasaRosa.calcularDiasUteis(dataPag, dataEnvio)
      : calcularDiasUteis(dataPag, dataEnvio);

    if (!tempos[loja]) tempos[loja] = [];
    tempos[loja].push(dias);
  });

  const medias = Object.entries(tempos).map(([loja, dias]) => {
    const total = dias.reduce((acc, d) => acc + d, 0);
    return [loja, total / dias.length];
  }).sort((a, b) => b[1] - a[1]);

  const labels = medias.map(([loja]) => loja);
  const data = medias.map(([_, media]) => Number(media.toFixed(2)));

  const ctx = document.getElementById("graficoTempoEnvio").getContext("2d");

  if (AppCasaRosa.graficoTempoEnvio) AppCasaRosa.graficoTempoEnvio.destroy();

  AppCasaRosa.graficoTempoEnvio = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label: "Dias √∫teis (m√©dia)",
        data,
        backgroundColor: "#EF5DA8"
      }]
    },
    options: {
      indexAxis: "y",
      responsive: true,
      scales: {
        x: {
          beginAtZero: true,
          title: { display: true, text: "Dias √∫teis" },
          ticks: { precision: 0 }
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: context => `${context.parsed.x} dias √∫teis`
          }
        }
      }
    }
  });
};

// Inicialize a refer√™ncia do gr√°fico no namespace, se ainda n√£o existir:
AppCasaRosa.graficoTempoEnvio = null;
// Encapsule a fun√ß√£o no namespace
AppCasaRosa.alternarTema = function() {
  const body = document.body;
  const botao = document.getElementById("btnTema");

  body.classList.toggle("dark-mode");

  if (body.classList.contains("dark-mode")) {
    botao.textContent = "üåû Modo Claro";
    localStorage.setItem("tema", "escuro");
  } else {
    botao.textContent = "üåô Modo Escuro";
    localStorage.setItem("tema", "claro");
  }
};

// Ao carregar, aplica o tema salvo (pode ser colocado fora ou dentro do namespace)
document.addEventListener("DOMContentLoaded", () => {
  const temaSalvo = localStorage.getItem("tema");
  const body = document.body;
  const botao = document.getElementById("btnTema");

  if (temaSalvo === "escuro") {
    body.classList.add("dark-mode");
    if (botao) botao.textContent = "üåû Modo Claro";
  }
});
AppCasaRosa.gerarRelatorioDetalhado = function() {
  const enviados = AppCasaRosa.enviadosList || [];
  const dataSelecionada = document.getElementById("filtroDataDashboard")?.value;
  const considerarMesInteiro = document.getElementById("filtroMesInteiroDashboard")?.checked;
  const lojaSelecionada = document.getElementById("filtroLojaDashboard")?.value;

  const resumo = {};

  enviados.forEach(p => {
    if (!p.dataEnvio) return;

    const dataEnvioStr = p.dataEnvio.split("T")[0];
    const [ano, mes] = dataEnvioStr.split("-").map(Number);
    const dataPedido = new Date(ano, mes - 1);

    if (dataSelecionada) {
      const [anoSel, mesSel] = dataSelecionada.split("-").map(Number);
      if (considerarMesInteiro && (ano !== anoSel || mes !== mesSel)) return;
      if (!considerarMesInteiro && dataEnvioStr !== dataSelecionada) return;
    }

    const loja = p.Loja || "Loja desconhecida";
    const produto = p.SKU || "Produto desconhecido";

    if (lojaSelecionada && loja !== lojaSelecionada) return;

    if (!resumo[loja]) resumo[loja] = {};
    if (!resumo[loja][produto]) resumo[loja][produto] = 0;

    resumo[loja][produto]++;
  });

  const container = document.getElementById("tabela-detalhada-vendas");
  container.innerHTML = "";

  if (!Object.keys(resumo).length) {
    container.innerHTML = "<div style='color:#6c757d;'>Nenhuma venda encontrada.</div>";
    return;
  }

  // Monta HTML da tabela
  let html = `<div style="overflow-x:auto;"><table border="1" cellspacing="0" cellpadding="5" style="width:100%; border-collapse:collapse;">
                <thead><tr><th>Loja</th><th>Produto</th><th>Quantidade</th></tr></thead><tbody>`;

  Object.entries(resumo).forEach(([loja, produtos]) => {
    Object.entries(produtos).forEach(([produto, qtd]) => {
      html += `<tr>
                 <td>${loja}</td>
                 <td>${produto}</td>
                 <td style="text-align:right;">${qtd}</td>
               </tr>`;
    });
  });

  html += `</tbody></table></div>`;
  container.innerHTML = html;
};
AppCasaRosa.adicionarMetaManual = async function(event) {
  event.preventDefault();
  const lojasSelecionadas = Array.from(document.getElementById('inputLojasMeta').selectedOptions).map(opt => opt.value);
  const produto = document.getElementById('inputProdutoMeta').value.trim();
  const valor = parseInt(document.getElementById('inputValorMeta').value);
  const mes = document.getElementById('inputMesMeta').value;

  if (!produto || !valor || !mes || lojasSelecionadas.length === 0) {
    alert("Preencha todos os campos corretamente.");
    return;
  }

  await addDoc(collection(db, "metas_mensais"), {
    produto,
    valor,
    mes,
    lojas: lojasSelecionadas,
    dataCadastro: new Date().toISOString()
  });

  alert("‚úÖ Meta adicionada com sucesso!");
  document.getElementById('inputProdutoMeta').value = "";
  document.getElementById('inputValorMeta').value = "";
  AppCasaRosa.renderizarMetasManuais();
};

AppCasaRosa.renderizarMetasManuais = async function() {
  const container = document.getElementById("containerMetasCards");
  container.innerHTML = "<p style='color:#888;'>Carregando metas...</p>";

  try {
    const snap = await AppCasaRosa.getDocs(AppCasaRosa.collection(AppCasaRosa.db, "metas_mensais"));
    const metas = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    const vendidos = AppCasaRosa.enviadosList || [];

    const agrupado = {};
    metas.forEach(meta => {
      const chave = `${meta.mes}|${meta.lojas.sort().join(",")}`;
      if (!agrupado[chave]) agrupado[chave] = { lojas: meta.lojas, mes: meta.mes, produtos: [] };
      agrupado[chave].produtos.push({ id: meta.id, produto: meta.produto, valor: meta.valor });
    });

    container.innerHTML = "";
    const hoje = new Date();

    Object.entries(agrupado).forEach(([chave, grupo]) => {
      const card = document.createElement("div");
      card.style = "background:white; border:1px solid #ccc; border-radius:8px; padding:1rem; box-shadow:0 1px 4px rgba(0,0,0,0.05); margin-bottom:1rem;";

      const diasDoMes = new Date(grupo.mes.split("-")[0], grupo.mes.split("-")[1], 0).getDate();
      const diaHoje = hoje.getDate();

      const produtosHtml = grupo.produtos.map(meta => {
        const vendidosTotal = vendidos.filter(e => {
          const lojaOk = grupo.lojas.includes(e.Loja);
          const equivalents = AppCasaRosa.skusEquivalentes || {};
          const grupoEquivalente = Object.entries(equivalents).find(([base, aliases]) => {
            return base === meta.produto || aliases.includes(meta.produto);
          });
          const todosRelacionados = grupoEquivalente ? [grupoEquivalente[0], ...grupoEquivalente[1]] : [meta.produto];
          const produtoOk = todosRelacionados.includes(e.SKU);
          const dataOk = e.dataEnvio && e.dataEnvio.startsWith(grupo.mes);
          return lojaOk && produtoOk && dataOk;
        }).length;

        const metaDiaria = Math.ceil(meta.valor / diasDoMes);
        const projecao = Math.round((vendidosTotal / diaHoje) * diasDoMes);
        const percentual = Math.round((vendidosTotal / meta.valor) * 100);
        const cor = percentual >= 66 ? '#198754' : percentual >= 33 ? '#ffc107' : '#dc3545';

        return `
          <tr>
            <td>${meta.produto}</td>
            <td>${meta.valor}</td>
            <td>${metaDiaria}/dia</td>
            <td>${vendidosTotal}</td>
            <td style="min-width:120px;">
              <div style="background:#e9ecef; border-radius:6px; height:20px; overflow:hidden;">
                <div style="
                  width:${Math.min(percentual, 100)}%;
                  background:${cor};
                  color:white;
                  height:100%;
                  display:flex;
                  align-items:center;
                  justify-content:center;
                  font-size:0.85rem;
                  font-weight:bold;
                  transition: width 0.3s;
                ">
                  ${percentual}%
                </div>
              </div>
            </td>
            <td style="color:#555; font-size:0.85rem;">üîÆ ${projecao} estimado</td>
            <td style="text-align:center;">
              <button onclick="AppCasaRosa.editarMeta('${meta.id}', ${meta.valor})">‚úèÔ∏è</button>
              <button onclick="AppCasaRosa.excluirMeta('${meta.id}')">üóëÔ∏è</button>
            </td>
          </tr>
        `;
      }).join("");

      card.innerHTML = `
        <div style="margin-bottom:0.5rem;font-weight:bold;color:#333;">
          üìÖ M√™s: ${grupo.mes}<br />
          üè™ Lojas: ${grupo.lojas.join(", ")}
        </div>
        <div style="overflow-x:auto;"><table style="width:100%;border-collapse:collapse;">
          <thead>
            <tr style="background:#eee;">
              <th style="padding:4px;">Produto</th>
              <th style="padding:4px;">Meta</th>
              <th style="padding:4px;">Meta Di√°ria</th>
              <th style="padding:4px;">Alcan√ßado</th>
              <th style="padding:4px;">%</th>
              <th style="padding:4px;">Proje√ß√£o</th>
              <th style="padding:4px;">A√ß√µes</th>
            </tr>
          </thead>
          <tbody>${produtosHtml}</tbody>
        </table></div>
      `;

      container.appendChild(card);
    });

  } catch (e) {
    container.innerHTML = "<p style='color:red;'>Erro ao carregar metas.</p>";
    console.error(e);
  }
};
AppCasaRosa.removerMetaManual = async function(id) {
  if (!confirm("Deseja remover esta meta?")) return;
  await deleteDoc(doc(db, "metas_mensais", id));
  AppCasaRosa.renderizarMetasManuais();
};

AppCasaRosa.preencherLojasInputMeta = function() {
  const lojas = [...new Set((AppCasaRosa.enviadosList || []).map(p => p.Loja).filter(Boolean))].sort();
  const select = document.getElementById("inputLojasMeta");
  select.innerHTML = lojas.map(l => `<option value="${l}">${l}</option>`).join("");
};
 AppCasaRosa.preencherFiltroLojaMetas = function() {
  const lojas = [...new Set((AppCasaRosa.enviadosList || []).map(p => p.Loja).filter(Boolean))].sort();
  const select = document.getElementById("filtroLojaMetas");
  if (!select) return;
  select.innerHTML = '<option value="">Todas</option>' + lojas.map(l => `<option value="${l}">${l}</option>`).join('');
};

AppCasaRosa.atualizarRelatorioMetas = function() {
  const enviados = AppCasaRosa.enviadosList || [];
  const dataSel = document.getElementById('filtroDataMetas')?.value;
  const considerarMes = document.getElementById('filtroMesInteiroMetas')?.checked;
  const lojaSel = document.getElementById('filtroLojaMetas')?.value;

  const resumo = {};
  enviados.forEach(p => {
    if (!p.dataEnvio) return;
    const envioStr = p.dataEnvio.split('T')[0];
    if (dataSel) {
      if (considerarMes) {
        const [anoSel, mesSel] = dataSel.split('-').map(Number);
        const [ano, mes] = envioStr.split('-').map(Number);
        if (ano !== anoSel || mes !== mesSel) return;
      } else if (envioStr !== dataSel) {
        return;
      }
    }
    const loja = p.Loja || 'Loja desconhecida';
    if (lojaSel && loja !== lojaSel) return;
    const produto = AppCasaRosa.obterSkuBase ? AppCasaRosa.obterSkuBase(p.SKU) : (p.SKU || 'Produto desconhecido');
    if (!resumo[loja]) resumo[loja] = {};
    resumo[loja][produto] = (resumo[loja][produto] || 0) + 1;
  });

  const container = document.getElementById('tabela-vendas-metas');
  container.innerHTML = '';
  if (!Object.keys(resumo).length) {
    container.innerHTML = "<div style='color:#888;'>Nenhuma venda encontrada.</div>";
    return;
  }

  let html = `<div style="overflow-x:auto;"><table border="1" cellspacing="0" cellpadding="5" style="width:100%; border-collapse:collapse;">`;
  html += '<thead><tr><th>Loja</th><th>Produto</th><th>Quantidade</th><th>Valor Esperado</th></tr></thead><tbody>';
  Object.entries(resumo).forEach(([loja, produtos]) => {
    Object.entries(produtos).forEach(([produto, qtd]) => {
      const sobra = AppCasaRosa.produtosMap && AppCasaRosa.produtosMap[produto] ? parseFloat(AppCasaRosa.produtosMap[produto].sobraIdeal) : 0;
      const valorEsperado = sobra * qtd;
      const valorFormatado = valorEsperado.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
      html += `<tr><td>${loja}</td><td>${produto}</td><td style="text-align:right;">${qtd}</td><td style="text-align:right;">${valorFormatado}</td></tr>`;
    });
  });
  html += '</tbody></table></div>';
  container.innerHTML = html;
};
AppCasaRosa.calcularProjecaoMeta = function(valorMeta, vendidos, diasDoMes, hoje) {
  const mediaDiaria = vendidos / hoje;
  const estimadoFinal = Math.round(mediaDiaria * diasDoMes);
  return estimadoFinal;
};

AppCasaRosa.calcularAtrasoMeta = function(metaDiaria, vendidos, diaHoje) {
  const idealHoje = metaDiaria * diaHoje;
  const atraso = idealHoje - vendidos;
  return atraso > 0 ? atraso : 0;
};
  window.AppCasaRosa = window.AppCasaRosa || {};
window.AppCasaRosa.atualizarCardsMetas = async function() {
  const container = document.getElementById("container-cards-metas");
  container.innerHTML = "<div>Carregando...</div>";

  const snap = await AppCasaRosa.getDocs(AppCasaRosa.collection(AppCasaRosa.db, "metas_mensais"));
  const metas = snap.docs.map(d => ({ id: d.id, ...d.data() }));

  const hoje = new Date();
  const diaAtual = hoje.getDate();
  const diasNoMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0).getDate();

  const enviados = AppCasaRosa.enviadosList || [];
  const progresso = {};

  enviados.forEach(p => {
    const dt = new Date(p.dataEnvio);
    if (isNaN(dt)) return;
    const mes = `${dt.getFullYear()}-${String(dt.getMonth() + 1).padStart(2, "0")}`;
    const loja = p.Loja || p.loja || "";
    const sku = AppCasaRosa.obterSkuPrincipal ? AppCasaRosa.obterSkuPrincipal(p.SKU || "Desconhecido") : (p.SKU || "Desconhecido");
    const chave = `${mes}__${loja}__${sku}`;
    progresso[chave] = (progresso[chave] || 0) + 1;
  });

  container.innerHTML = "";

  metas.forEach(meta => {
    const metaMensal = meta.valor;
    const metaDiaria = Math.ceil(metaMensal / diasNoMes);
    const metaAteHoje = metaDiaria * diaAtual;

    const vendido = meta.lojas.reduce((total, loja) => {
      const chave = `${meta.mes}__${loja}__${meta.produto}`;
      return total + (progresso[chave] || 0);
    }, 0);

    const percentual = Math.round((vendido / metaMensal) * 100);
    const atraso = metaAteHoje - vendido;

    const cor = percentual >= 100 ? '#198754' :
                percentual >= 50  ? '#0d6efd' :
                '#dc3545';

    const card = document.createElement("div");
    card.style = `
      background:white;
      border:1px solid #ccc;
      border-radius:8px;
      padding:1rem;
      box-shadow:0 2px 4px rgba(0,0,0,0.05);
      margin-bottom:1rem;
    `;

    card.innerHTML = `
      <h4 style="margin:0 0 0.5rem 0;">üì¶ ${meta.produto}</h4>
      <div style="font-size:0.9rem;color:#555;">üóìÔ∏è M√™s: ${meta.mes}</div>
      <div style="font-size:0.9rem;color:#555;">üè™ ${meta.lojas.join(", ")}</div>
      <div style="margin:0.5rem 0;">üéØ Meta Mensal: <strong>${metaMensal}</strong></div>
      <div style="margin:0.25rem 0;">üìà Meta Di√°ria: ${metaDiaria}</div>
      <div style="margin:0.25rem 0;">‚úÖ Vendido at√© hoje: ${vendido}</div>
      <div style="margin:0.25rem 0;">üìä Progresso:</div>
      <div style="height:22px; background:#e9ecef; border-radius:6px; overflow:hidden; font-size:0.85rem; font-weight:bold;">
        <div style="
          height:100%;
          width:${Math.min(percentual, 100)}%;
          background:${cor};
          color:white;
          text-align:center;
          display:flex;
          align-items:center;
          justify-content:center;
          transition: width 0.3s;
        ">
          ${percentual}%
        </div>
      </div>
      ${atraso > 0 ? `<div style="color:#dc3545; font-weight:bold; margin-top:0.5rem;">üö® Atraso de ${atraso} unidades</div>` : ""}
      <div style="margin-top:0.75rem;">
        <button onclick="AppCasaRosa.editarMeta('${meta.id}', ${meta.valor})" style="margin-right: 0.5rem;">‚úèÔ∏è Editar</button>
        <button onclick="AppCasaRosa.excluirMeta('${meta.id}')">üóëÔ∏è Excluir</button>
      </div>
    `;

    container.appendChild(card);
  });
};

// Atualiza automaticamente ap√≥s o carregamento da p√°gina
document.addEventListener("DOMContentLoaded", () => {
  setTimeout(() => {
    if (AppCasaRosa.atualizarCardsMetas) {
      AppCasaRosa.atualizarCardsMetas();
    }
  }, 1000);
});

AppCasaRosa.salvarSkuEquivalente = async function (event) {
  event.preventDefault();

  const base = document.getElementById("skuBase").value.trim().toUpperCase();
  const equivalentes = document.getElementById("skusEquivalentes").value
    .split(",")
    .map(s => s.trim().toUpperCase())
    .filter(Boolean);

  if (!base || equivalentes.length === 0) return;

  // üîç Verifica se j√° existe esse agrupamento no Firebase
  const snap = await AppCasaRosa.getDocs(AppCasaRosa.collection(AppCasaRosa.db, "skus_equivalentes"));
  const existente = snap.docs.find(doc => doc.data().base === base);

  if (existente) {
    // Atualiza se j√° existir
   await AppCasaRosa.updateDoc(
      AppCasaRosa.doc(AppCasaRosa.db, "skus_equivalentes", existente.id),
      { equivalentes }
    );
  } else {
    // Cria novo agrupamento
    await AppCasaRosa.addDoc(
      AppCasaRosa.collection(AppCasaRosa.db, "skus_equivalentes"),
      { base, equivalentes }
    );
  }

  document.getElementById("formSkus").reset();
  AppCasaRosa.carregarSkusEquivalentes && AppCasaRosa.carregarSkusEquivalentes();
};

AppCasaRosa.listarSkusEquivalentes = function() {
  const tbody = document.querySelector("#tabelaSkus tbody");
  tbody.innerHTML = "";

  const dados = AppCasaRosa.skusEquivalentes || {};
  Object.entries(dados).forEach(([base, equivalentes]) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${base}</td>
      <td>${equivalentes.join(", ")}</td>
      <td><button onclick="AppCasaRosa.excluirSkuEquivalente('${base}')">üóëÔ∏è Excluir</button></td>
    `;
    tbody.appendChild(tr);
  });
};

AppCasaRosa.excluirSkuEquivalente = async function(base) {
  try {
    const snap = await AppCasaRosa.getDocs(AppCasaRosa.collection(AppCasaRosa.db, "skus_equivalentes"));
    snap.forEach(docItem => {
      if (docItem.data().base === base) {
        deleteDoc(doc(db, "skus_equivalentes", docItem.id));
      }
    });

    await AppCasaRosa.registrarLog
      ? AppCasaRosa.registrarLog("Excluiu agrupamento de SKU", { skuBase: base })
      : registrarLog("Excluiu agrupamento de SKU", { skuBase: base });

    if (AppCasaRosa.carregarSkusEquivalentes) {
      await AppCasaRosa.carregarSkusEquivalentes(); // Recarrega os dados sincronizados
    }
  } catch (e) {
    console.error("Erro ao excluir SKU:", e);
    alert("Erro ao excluir agrupamento.");
  }
};

window.salvarSkuEquivalente = AppCasaRosa.salvarSkuEquivalente;
window.excluirSkuEquivalente = AppCasaRosa.excluirSkuEquivalente;
window.renderizarTabelaSkus = AppCasaRosa.renderizarTabelaSkus;

AppCasaRosa.excluirMeta = async function(id) {
  if (!confirm("Deseja realmente excluir esta meta?")) return;

  try {
    await deleteDoc(doc(db, "metas_mensais", id));
    if (AppCasaRosa.registrarLog) {
      await AppCasaRosa.registrarLog("Excluiu Meta", { metaId: id });
    } else {
      await registrarLog("Excluiu Meta", { metaId: id });
    }

    alert("Meta exclu√≠da com sucesso.");
    if (AppCasaRosa.atualizarCardsMetas) {
      AppCasaRosa.atualizarCardsMetas();
    }
  } catch (e) {
    console.error("Erro ao excluir meta:", e);
    alert("Erro ao excluir meta.");
  }
};

AppCasaRosa.editarMeta = async function(id, valorAtual) {
  const novoValorStr = prompt("Novo valor da meta:", valorAtual);
  if (novoValorStr === null) return;

  const novoValor = parseInt(novoValorStr);
  if (isNaN(novoValor) || novoValor <= 0) {
    alert("Valor inv√°lido.");
    return;
  }

  try {
    await updateDoc(doc(db, "metas_mensais", id), { valor: novoValor });
    if (AppCasaRosa.registrarLog) {
      await AppCasaRosa.registrarLog("Editou Meta", { metaId: id, valor: novoValor });
    } else {
      await registrarLog("Editou Meta", { metaId: id, valor: novoValor });
    }

    if (AppCasaRosa.renderizarMetasManuais) {
      AppCasaRosa.renderizarMetasManuais();
    } else {
      renderizarMetasManuais();
    }

    if (AppCasaRosa.atualizarCardsMetas) {
      AppCasaRosa.atualizarCardsMetas();
    } else {
      atualizarCardsMetas();
    }

    alert("Meta atualizada com sucesso.");
  } catch (e) {
    console.error("Erro ao editar meta:", e);
    alert("Erro ao editar meta.");
  }
};


AppCasaRosa.registrarLog = async function(acao, detalhes = {}) {
  const user = auth.currentUser;
  if (!user) return;

  const log = {
    usuario: user.email,
    acao: acao,
    detalhes: detalhes,
    timestamp: new Date().toISOString()
  };

  try {
    await addDoc(collection(db, "logs"), log);
    console.log("üîé Log registrado:", log);
  } catch (e) {
    console.error("Erro ao registrar log:", e);
  }
};
AppCasaRosa.carregarLogs = async function() {
  const snap = await getDocs(query(collection(db, "logs"), orderBy("timestamp", "desc")));
  const logs = snap.docs.map(doc => doc.data());

  const container = document.getElementById("tabelaLogs");
  container.innerHTML = logs.slice(0, 100).map(log => `
    <div style="border-bottom:1px solid #ddd; padding:0.5rem 0;">
      <strong>${log.usuario}</strong> ‚Äì ${log.acao}<br>
      <small>${new Date(log.timestamp).toLocaleString()}</small><br>
      <pre style="background:#f8f8f8;padding:0.5rem;border-radius:5px;">${JSON.stringify(log.detalhes, null, 2)}</pre>
    </div>
  `).join("");
};

AppCasaRosa.carregarSkusEquivalentes = async function() {
  const snap = await AppCasaRosa.getDocs(AppCasaRosa.collection(AppCasaRosa.db, "skus_equivalentes"));
  AppCasaRosa.skusEquivalentes = {};
  snap.forEach(doc => {
    const data = doc.data();
    AppCasaRosa.skusEquivalentes[data.base] = data.equivalentes;
  });
  if (typeof AppCasaRosa.renderizarTabelaSkus === "function") {
    AppCasaRosa.renderizarTabelaSkus(); // Atualiza tabela na tela
  } else if (typeof renderizarTabelaSkus === "function") {
    renderizarTabelaSkus();
  }
};


AppCasaRosa.atualizarCardsMetas = async function () {
  try {
    const container = document.getElementById("cardsMetas");
    if (!container) return;

    // Limpa o conte√∫do atual
    container.innerHTML = "<p>üîÑ Atualizando metas...</p>";

    // Busca metas no Firebase
    const snap = await AppCasaRosa.getDocs(AppCasaRosa.collection(AppCasaRosa.db, "metas_mensais"));
    if (snap.empty) {
      container.innerHTML = "<p>‚ö†Ô∏è Nenhuma meta encontrada.</p>";
      return;
    }

    // Estrutura para agrupar e renderizar
    let html = '';
    snap.forEach(doc => {
      const meta = doc.data();
      html += `
        <div class="card-meta">
          <h3>üì¶ Produto: ${meta.produto || "Sem nome"}</h3>
          <p>üéØ Meta: <strong>${meta.meta || 0}</strong> unidades</p>
          <p>üè™ Loja: ${meta.loja || "Todas"}</p>
          <p>üóìÔ∏è M√™s: ${meta.mes || "Indefinido"}</p>
          <button onclick="AppCasaRosa.excluirMeta('${doc.id}')">üóëÔ∏è Excluir</button>
        </div>
      `;
    });

    // Renderiza os cards
    container.innerHTML = html;

  } catch (e) {
    console.error("Erro ao atualizar os cards de metas:", e);
    const container = document.getElementById("cardsMetas");
    if (container) container.innerHTML = "<p>‚ùå Erro ao carregar metas.</p>";
  }
};


  AppCasaRosa.carregarProdutos = async function() {
const snap = await AppCasaRosa.getDocs(AppCasaRosa.collection(AppCasaRosa.db, "produtos"));
  const tbody = document.querySelector("#tabelaProdutos tbody");
  AppCasaRosa.produtosMap = {};
  if (tbody) tbody.innerHTML = "";
  snap.forEach(docItem => {
    const data = docItem.data();
    AppCasaRosa.produtosMap[data.nome] = data;
    if (tbody) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${data.nome}</td>
        <td>${data.sobraIdeal}</td>
        <td>${data.valor ?? ''}</td>
        <td><button onclick="AppCasaRosa.excluirProduto('${docItem.id}')">üóëÔ∏è</button></td>
      `;
      tbody.appendChild(tr);
    }
  });
};


AppCasaRosa.salvarProduto = async function(event) {
  event.preventDefault();
  const nome = document.getElementById("nomeProduto").value.trim();
  const sobra = parseInt(document.getElementById("sobraIdeal").value);
  const valor = parseFloat(document.getElementById("valorProduto").value);
  if (!nome || isNaN(sobra) || isNaN(valor)) return;
  await addDoc(collection(db, "produtos"), { nome, sobraIdeal: sobra, valor });
  if (AppCasaRosa.registrarLog) {
    await AppCasaRosa.registrarLog("Adicionou Produto", { nome, valor });
  } else {
    await registrarLog("Adicionou Produto", { nome, valor });
  }
  document.getElementById("formProduto").reset();
  if (AppCasaRosa.carregarProdutos) {
    AppCasaRosa.carregarProdutos();
  }
};
window.salvarProduto = AppCasaRosa.salvarProduto;

AppCasaRosa.excluirProduto = async function(id) {
  if (!confirm("Excluir produto?")) return;
  await deleteDoc(doc(db, "produtos", id));
  if (AppCasaRosa.registrarLog) {
    await AppCasaRosa.registrarLog("Excluiu Produto", { id });
  } else {
    await registrarLog("Excluiu Produto", { id });
  }
  if (AppCasaRosa.carregarProdutos) {
    AppCasaRosa.carregarProdutos();
  
  }
};
window.excluirProduto = AppCasaRosa.excluirProduto;
AppCasaRosa.obterSkuPrincipal = function(sku) {
  const equivalentes = AppCasaRosa.skusEquivalentes || {};
  for (const base in equivalentes) {
    const aliases = equivalentes[base];
    if (sku === base || (Array.isArray(aliases) && aliases.includes(sku))) {
      return base;
    }
  }
  return sku;
};
document.addEventListener("DOMContentLoaded", () => {
  if (typeof AppCasaRosa.atualizarResumoVendasMensal === "function") {
    AppCasaRosa.atualizarResumoVendasMensal();
  }
});

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
</body>


</html>
